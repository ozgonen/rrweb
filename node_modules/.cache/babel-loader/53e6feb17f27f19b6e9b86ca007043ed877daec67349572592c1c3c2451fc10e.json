{"ast":null,"code":"import { initMutationObserver, initScrollObserver, initAdoptedStyleSheetObserver } from './observer.js';\nimport { patch } from '../utils.js';\nimport { isNativeShadowDom } from '../../../rrweb-snapshot/es/rrweb-snapshot.js';\nclass ShadowDomManager {\n  constructor(options) {\n    this.shadowDoms = new WeakSet();\n    this.restorePatches = [];\n    this.mutationCb = options.mutationCb;\n    this.scrollCb = options.scrollCb;\n    this.bypassOptions = options.bypassOptions;\n    this.mirror = options.mirror;\n    const manager = this;\n    this.restorePatches.push(patch(Element.prototype, 'attachShadow', function (original) {\n      return function (option) {\n        const shadowRoot = original.call(this, option);\n        if (this.shadowRoot) manager.addShadowRoot(this.shadowRoot, this.ownerDocument);\n        return shadowRoot;\n      };\n    }));\n  }\n  addShadowRoot(shadowRoot, doc) {\n    if (!isNativeShadowDom(shadowRoot)) return;\n    if (this.shadowDoms.has(shadowRoot)) return;\n    this.shadowDoms.add(shadowRoot);\n    initMutationObserver(Object.assign(Object.assign({}, this.bypassOptions), {\n      doc,\n      mutationCb: this.mutationCb,\n      mirror: this.mirror,\n      shadowDomManager: this\n    }), shadowRoot);\n    initScrollObserver(Object.assign(Object.assign({}, this.bypassOptions), {\n      scrollCb: this.scrollCb,\n      doc: shadowRoot,\n      mirror: this.mirror\n    }));\n    setTimeout(() => {\n      if (shadowRoot.adoptedStyleSheets && shadowRoot.adoptedStyleSheets.length > 0) this.bypassOptions.stylesheetManager.adoptStyleSheets(shadowRoot.adoptedStyleSheets, this.mirror.getId(shadowRoot.host));\n      initAdoptedStyleSheetObserver({\n        mirror: this.mirror,\n        stylesheetManager: this.bypassOptions.stylesheetManager\n      }, shadowRoot);\n    }, 0);\n  }\n  observeAttachShadow(iframeElement) {\n    if (iframeElement.contentWindow) {\n      const manager = this;\n      this.restorePatches.push(patch(iframeElement.contentWindow.HTMLElement.prototype, 'attachShadow', function (original) {\n        return function (option) {\n          const shadowRoot = original.call(this, option);\n          if (this.shadowRoot) manager.addShadowRoot(this.shadowRoot, iframeElement.contentDocument);\n          return shadowRoot;\n        };\n      }));\n    }\n  }\n  reset() {\n    this.restorePatches.forEach(restorePatch => restorePatch());\n    this.shadowDoms = new WeakSet();\n  }\n}\nexport { ShadowDomManager };","map":{"version":3,"names":["initMutationObserver","initScrollObserver","initAdoptedStyleSheetObserver","patch","isNativeShadowDom","ShadowDomManager","constructor","options","shadowDoms","WeakSet","restorePatches","mutationCb","scrollCb","bypassOptions","mirror","manager","push","Element","prototype","original","option","shadowRoot","call","addShadowRoot","ownerDocument","doc","has","add","Object","assign","shadowDomManager","setTimeout","adoptedStyleSheets","length","stylesheetManager","adoptStyleSheets","getId","host","observeAttachShadow","iframeElement","contentWindow","HTMLElement","contentDocument","reset","forEach","restorePatch"],"sources":["/Users/ogonen/rrweb/node_modules/rrweb/es/rrweb/packages/rrweb/src/record/shadow-dom-manager.js"],"sourcesContent":["import { initMutationObserver, initScrollObserver, initAdoptedStyleSheetObserver } from './observer.js';\nimport { patch } from '../utils.js';\nimport { isNativeShadowDom } from '../../../rrweb-snapshot/es/rrweb-snapshot.js';\n\nclass ShadowDomManager {\r\n    constructor(options) {\r\n        this.shadowDoms = new WeakSet();\r\n        this.restorePatches = [];\r\n        this.mutationCb = options.mutationCb;\r\n        this.scrollCb = options.scrollCb;\r\n        this.bypassOptions = options.bypassOptions;\r\n        this.mirror = options.mirror;\r\n        const manager = this;\r\n        this.restorePatches.push(patch(Element.prototype, 'attachShadow', function (original) {\r\n            return function (option) {\r\n                const shadowRoot = original.call(this, option);\r\n                if (this.shadowRoot)\r\n                    manager.addShadowRoot(this.shadowRoot, this.ownerDocument);\r\n                return shadowRoot;\r\n            };\r\n        }));\r\n    }\r\n    addShadowRoot(shadowRoot, doc) {\r\n        if (!isNativeShadowDom(shadowRoot))\r\n            return;\r\n        if (this.shadowDoms.has(shadowRoot))\r\n            return;\r\n        this.shadowDoms.add(shadowRoot);\r\n        initMutationObserver(Object.assign(Object.assign({}, this.bypassOptions), { doc, mutationCb: this.mutationCb, mirror: this.mirror, shadowDomManager: this }), shadowRoot);\r\n        initScrollObserver(Object.assign(Object.assign({}, this.bypassOptions), { scrollCb: this.scrollCb, doc: shadowRoot, mirror: this.mirror }));\r\n        setTimeout(() => {\r\n            if (shadowRoot.adoptedStyleSheets &&\r\n                shadowRoot.adoptedStyleSheets.length > 0)\r\n                this.bypassOptions.stylesheetManager.adoptStyleSheets(shadowRoot.adoptedStyleSheets, this.mirror.getId(shadowRoot.host));\r\n            initAdoptedStyleSheetObserver({\r\n                mirror: this.mirror,\r\n                stylesheetManager: this.bypassOptions.stylesheetManager,\r\n            }, shadowRoot);\r\n        }, 0);\r\n    }\r\n    observeAttachShadow(iframeElement) {\r\n        if (iframeElement.contentWindow) {\r\n            const manager = this;\r\n            this.restorePatches.push(patch(iframeElement.contentWindow.HTMLElement.prototype, 'attachShadow', function (original) {\r\n                return function (option) {\r\n                    const shadowRoot = original.call(this, option);\r\n                    if (this.shadowRoot)\r\n                        manager.addShadowRoot(this.shadowRoot, iframeElement.contentDocument);\r\n                    return shadowRoot;\r\n                };\r\n            }));\r\n        }\r\n    }\r\n    reset() {\r\n        this.restorePatches.forEach((restorePatch) => restorePatch());\r\n        this.shadowDoms = new WeakSet();\r\n    }\r\n}\n\nexport { ShadowDomManager };\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}