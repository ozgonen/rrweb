{"ast":null,"code":"import { __awaiter } from './../../../../ext/tslib/tslib.es6.js';\nimport { createCache, createMirror, rebuild, buildNodeWithSN, NodeType } from '../../../rrweb-snapshot/es/rrweb-snapshot.js';\nimport { RRDocument, diff, createOrGetNode, getDefaultSN, buildFromDom, buildFromNode } from '../../../rrdom/es/rrdom.js';\nimport * as mitt$1 from './../../../../ext/mitt/dist/mitt.mjs.js';\nimport mitt$2 from './../../../../ext/mitt/dist/mitt.mjs.js';\nimport { polyfill } from './smoothscroll.js';\nimport { Timer } from './timer.js';\nimport { createPlayerService, createSpeedService } from './machine.js';\nimport { EventType, ReplayerEvents, IncrementalSource, MouseInteractions } from '../../../types/dist/types.js';\nimport { StyleSheetMirror, polyfill as polyfill$1, isSerializedIframe, hasShadowRoot, queueToResolveTrees, iterateResolveTree, uniqueTextMutations, getPositionsAndIndex, getNestedRule, getBaseDimension } from '../utils.js';\nimport rules from './styles/inject-style.js';\nimport canvasMutation from './canvas/index.js';\nimport { deserializeArg } from './canvas/deserialize-args.js';\nconst SKIP_TIME_THRESHOLD = 10 * 1000;\nconst SKIP_TIME_INTERVAL = 5 * 1000;\nconst mitt = mitt$2 || mitt$1;\nconst REPLAY_CONSOLE_PREFIX = '[replayer]';\nconst defaultMouseTailConfig = {\n  duration: 500,\n  lineCap: 'round',\n  lineWidth: 3,\n  strokeStyle: 'red'\n};\nfunction indicatesTouchDevice(e) {\n  return e.type == EventType.IncrementalSnapshot && (e.data.source == IncrementalSource.TouchMove || e.data.source == IncrementalSource.MouseInteraction && e.data.type == MouseInteractions.TouchStart);\n}\nclass Replayer {\n  constructor(events, config) {\n    this.usingVirtualDom = false;\n    this.virtualDom = new RRDocument();\n    this.mouseTail = null;\n    this.tailPositions = [];\n    this.emitter = mitt();\n    this.legacy_missingNodeRetryMap = {};\n    this.cache = createCache();\n    this.imageMap = new Map();\n    this.canvasEventMap = new Map();\n    this.mirror = createMirror();\n    this.styleMirror = new StyleSheetMirror();\n    this.firstFullSnapshot = null;\n    this.newDocumentQueue = [];\n    this.mousePos = null;\n    this.touchActive = null;\n    this.lastSelectionData = null;\n    this.constructedStyleMutations = [];\n    this.adoptedStyleSheets = [];\n    this.handleResize = dimension => {\n      this.iframe.style.display = 'inherit';\n      for (const el of [this.mouseTail, this.iframe]) {\n        if (!el) {\n          continue;\n        }\n        el.setAttribute('width', String(dimension.width));\n        el.setAttribute('height', String(dimension.height));\n      }\n    };\n    this.applyEventsSynchronously = events => {\n      for (const event of events) {\n        switch (event.type) {\n          case EventType.DomContentLoaded:\n          case EventType.Load:\n          case EventType.Custom:\n            continue;\n          case EventType.FullSnapshot:\n          case EventType.Meta:\n          case EventType.Plugin:\n          case EventType.IncrementalSnapshot:\n            break;\n        }\n        const castFn = this.getCastFn(event, true);\n        castFn();\n      }\n      if (this.touchActive === true) {\n        this.mouse.classList.add('touch-active');\n      } else if (this.touchActive === false) {\n        this.mouse.classList.remove('touch-active');\n      }\n      this.touchActive = null;\n    };\n    this.getCastFn = (event, isSync = false) => {\n      let castFn;\n      switch (event.type) {\n        case EventType.DomContentLoaded:\n        case EventType.Load:\n          break;\n        case EventType.Custom:\n          castFn = () => {\n            this.emitter.emit(ReplayerEvents.CustomEvent, event);\n          };\n          break;\n        case EventType.Meta:\n          castFn = () => this.emitter.emit(ReplayerEvents.Resize, {\n            width: event.data.width,\n            height: event.data.height\n          });\n          break;\n        case EventType.FullSnapshot:\n          castFn = () => {\n            var _a;\n            if (this.firstFullSnapshot) {\n              if (this.firstFullSnapshot === event) {\n                this.firstFullSnapshot = true;\n                return;\n              }\n            } else {\n              this.firstFullSnapshot = true;\n            }\n            this.rebuildFullSnapshot(event, isSync);\n            (_a = this.iframe.contentWindow) === null || _a === void 0 ? void 0 : _a.scrollTo(event.data.initialOffset);\n            this.styleMirror.reset();\n          };\n          break;\n        case EventType.IncrementalSnapshot:\n          castFn = () => {\n            this.applyIncremental(event, isSync);\n            if (isSync) {\n              return;\n            }\n            if (event === this.nextUserInteractionEvent) {\n              this.nextUserInteractionEvent = null;\n              this.backToNormal();\n            }\n            if (this.config.skipInactive && !this.nextUserInteractionEvent) {\n              for (const _event of this.service.state.context.events) {\n                if (_event.timestamp <= event.timestamp) {\n                  continue;\n                }\n                if (this.isUserInteraction(_event)) {\n                  if (_event.delay - event.delay > SKIP_TIME_THRESHOLD * this.speedService.state.context.timer.speed) {\n                    this.nextUserInteractionEvent = _event;\n                  }\n                  break;\n                }\n              }\n              if (this.nextUserInteractionEvent) {\n                const skipTime = this.nextUserInteractionEvent.delay - event.delay;\n                const payload = {\n                  speed: Math.min(Math.round(skipTime / SKIP_TIME_INTERVAL), this.config.maxSpeed)\n                };\n                this.speedService.send({\n                  type: 'FAST_FORWARD',\n                  payload\n                });\n                this.emitter.emit(ReplayerEvents.SkipStart, payload);\n              }\n            }\n          };\n          break;\n      }\n      const wrappedCastFn = () => {\n        if (castFn) {\n          castFn();\n        }\n        for (const plugin of this.config.plugins || []) {\n          if (plugin.handler) plugin.handler(event, isSync, {\n            replayer: this\n          });\n        }\n        this.service.send({\n          type: 'CAST_EVENT',\n          payload: {\n            event\n          }\n        });\n        const last_index = this.service.state.context.events.length - 1;\n        if (event === this.service.state.context.events[last_index]) {\n          const finish = () => {\n            if (last_index < this.service.state.context.events.length - 1) {\n              return;\n            }\n            this.backToNormal();\n            this.service.send('END');\n            this.emitter.emit(ReplayerEvents.Finish);\n          };\n          if (event.type === EventType.IncrementalSnapshot && event.data.source === IncrementalSource.MouseMove && event.data.positions.length) {\n            setTimeout(() => {\n              finish();\n            }, Math.max(0, -event.data.positions[0].timeOffset + 50));\n          } else {\n            finish();\n          }\n        }\n        this.emitter.emit(ReplayerEvents.EventCast, event);\n      };\n      return wrappedCastFn;\n    };\n    if (!(config === null || config === void 0 ? void 0 : config.liveMode) && events.length < 2) {\n      throw new Error('Replayer need at least 2 events.');\n    }\n    const defaultConfig = {\n      speed: 1,\n      maxSpeed: 360,\n      root: document.body,\n      loadTimeout: 0,\n      skipInactive: false,\n      showWarning: true,\n      showDebug: false,\n      blockClass: 'rr-block',\n      liveMode: false,\n      insertStyleRules: [],\n      triggerFocus: true,\n      UNSAFE_replayCanvas: false,\n      pauseAnimation: true,\n      mouseTail: defaultMouseTailConfig,\n      useVirtualDom: true\n    };\n    this.config = Object.assign({}, defaultConfig, config);\n    this.handleResize = this.handleResize.bind(this);\n    this.getCastFn = this.getCastFn.bind(this);\n    this.applyEventsSynchronously = this.applyEventsSynchronously.bind(this);\n    this.emitter.on(ReplayerEvents.Resize, this.handleResize);\n    this.setupDom();\n    for (const plugin of this.config.plugins || []) {\n      if (plugin.getMirror) plugin.getMirror({\n        nodeMirror: this.mirror\n      });\n    }\n    this.emitter.on(ReplayerEvents.Flush, () => {\n      if (this.usingVirtualDom) {\n        const replayerHandler = {\n          mirror: this.mirror,\n          applyCanvas: (canvasEvent, canvasMutationData, target) => {\n            void canvasMutation({\n              event: canvasEvent,\n              mutation: canvasMutationData,\n              target,\n              imageMap: this.imageMap,\n              canvasEventMap: this.canvasEventMap,\n              errorHandler: this.warnCanvasMutationFailed.bind(this)\n            });\n          },\n          applyInput: this.applyInput.bind(this),\n          applyScroll: this.applyScroll.bind(this),\n          applyStyleSheetMutation: (data, styleSheet) => {\n            if (data.source === IncrementalSource.StyleSheetRule) this.applyStyleSheetRule(data, styleSheet);else if (data.source === IncrementalSource.StyleDeclaration) this.applyStyleDeclaration(data, styleSheet);\n          }\n        };\n        this.iframe.contentDocument && diff(this.iframe.contentDocument, this.virtualDom, replayerHandler, this.virtualDom.mirror);\n        this.virtualDom.destroyTree();\n        this.usingVirtualDom = false;\n        if (Object.keys(this.legacy_missingNodeRetryMap).length) {\n          for (const key in this.legacy_missingNodeRetryMap) {\n            try {\n              const value = this.legacy_missingNodeRetryMap[key];\n              const realNode = createOrGetNode(value.node, this.mirror, this.virtualDom.mirror);\n              diff(realNode, value.node, replayerHandler, this.virtualDom.mirror);\n              value.node = realNode;\n            } catch (error) {\n              if (this.config.showWarning) {\n                console.warn(error);\n              }\n            }\n          }\n        }\n        this.constructedStyleMutations.forEach(data => {\n          this.applyStyleSheetMutation(data);\n        });\n        this.constructedStyleMutations = [];\n        this.adoptedStyleSheets.forEach(data => {\n          this.applyAdoptedStyleSheet(data);\n        });\n        this.adoptedStyleSheets = [];\n      }\n      if (this.mousePos) {\n        this.moveAndHover(this.mousePos.x, this.mousePos.y, this.mousePos.id, true, this.mousePos.debugData);\n        this.mousePos = null;\n      }\n      if (this.lastSelectionData) {\n        this.applySelection(this.lastSelectionData);\n        this.lastSelectionData = null;\n      }\n    });\n    this.emitter.on(ReplayerEvents.PlayBack, () => {\n      this.firstFullSnapshot = null;\n      this.mirror.reset();\n      this.styleMirror.reset();\n    });\n    const timer = new Timer([], {\n      speed: this.config.speed,\n      liveMode: this.config.liveMode\n    });\n    this.service = createPlayerService({\n      events: events.map(e => {\n        if (config && config.unpackFn) {\n          return config.unpackFn(e);\n        }\n        return e;\n      }).sort((a1, a2) => a1.timestamp - a2.timestamp),\n      timer,\n      timeOffset: 0,\n      baselineTime: 0,\n      lastPlayedEvent: null\n    }, {\n      getCastFn: this.getCastFn,\n      applyEventsSynchronously: this.applyEventsSynchronously,\n      emitter: this.emitter\n    });\n    this.service.start();\n    this.service.subscribe(state => {\n      this.emitter.emit(ReplayerEvents.StateChange, {\n        player: state\n      });\n    });\n    this.speedService = createSpeedService({\n      normalSpeed: -1,\n      timer\n    });\n    this.speedService.start();\n    this.speedService.subscribe(state => {\n      this.emitter.emit(ReplayerEvents.StateChange, {\n        speed: state\n      });\n    });\n    const firstMeta = this.service.state.context.events.find(e => e.type === EventType.Meta);\n    const firstFullsnapshot = this.service.state.context.events.find(e => e.type === EventType.FullSnapshot);\n    if (firstMeta) {\n      const {\n        width,\n        height\n      } = firstMeta.data;\n      setTimeout(() => {\n        this.emitter.emit(ReplayerEvents.Resize, {\n          width,\n          height\n        });\n      }, 0);\n    }\n    if (firstFullsnapshot) {\n      setTimeout(() => {\n        var _a;\n        if (this.firstFullSnapshot) {\n          return;\n        }\n        this.firstFullSnapshot = firstFullsnapshot;\n        this.rebuildFullSnapshot(firstFullsnapshot);\n        (_a = this.iframe.contentWindow) === null || _a === void 0 ? void 0 : _a.scrollTo(firstFullsnapshot.data.initialOffset);\n      }, 1);\n    }\n    if (this.service.state.context.events.find(indicatesTouchDevice)) {\n      this.mouse.classList.add('touch-device');\n    }\n  }\n  get timer() {\n    return this.service.state.context.timer;\n  }\n  on(event, handler) {\n    this.emitter.on(event, handler);\n    return this;\n  }\n  off(event, handler) {\n    this.emitter.off(event, handler);\n    return this;\n  }\n  setConfig(config) {\n    Object.keys(config).forEach(key => {\n      config[key];\n      this.config[key] = config[key];\n    });\n    if (!this.config.skipInactive) {\n      this.backToNormal();\n    }\n    if (typeof config.speed !== 'undefined') {\n      this.speedService.send({\n        type: 'SET_SPEED',\n        payload: {\n          speed: config.speed\n        }\n      });\n    }\n    if (typeof config.mouseTail !== 'undefined') {\n      if (config.mouseTail === false) {\n        if (this.mouseTail) {\n          this.mouseTail.style.display = 'none';\n        }\n      } else {\n        if (!this.mouseTail) {\n          this.mouseTail = document.createElement('canvas');\n          this.mouseTail.width = Number.parseFloat(this.iframe.width);\n          this.mouseTail.height = Number.parseFloat(this.iframe.height);\n          this.mouseTail.classList.add('replayer-mouse-tail');\n          this.wrapper.insertBefore(this.mouseTail, this.iframe);\n        }\n        this.mouseTail.style.display = 'inherit';\n      }\n    }\n  }\n  getMetaData() {\n    const firstEvent = this.service.state.context.events[0];\n    const lastEvent = this.service.state.context.events[this.service.state.context.events.length - 1];\n    return {\n      startTime: firstEvent.timestamp,\n      endTime: lastEvent.timestamp,\n      totalTime: lastEvent.timestamp - firstEvent.timestamp\n    };\n  }\n  getCurrentTime() {\n    return this.timer.timeOffset + this.getTimeOffset();\n  }\n  getTimeOffset() {\n    const {\n      baselineTime,\n      events\n    } = this.service.state.context;\n    return baselineTime - events[0].timestamp;\n  }\n  getMirror() {\n    return this.mirror;\n  }\n  play(timeOffset = 0) {\n    var _a, _b;\n    if (this.service.state.matches('paused')) {\n      this.service.send({\n        type: 'PLAY',\n        payload: {\n          timeOffset\n        }\n      });\n    } else {\n      this.service.send({\n        type: 'PAUSE'\n      });\n      this.service.send({\n        type: 'PLAY',\n        payload: {\n          timeOffset\n        }\n      });\n    }\n    (_b = (_a = this.iframe.contentDocument) === null || _a === void 0 ? void 0 : _a.getElementsByTagName('html')[0]) === null || _b === void 0 ? void 0 : _b.classList.remove('rrweb-paused');\n    this.emitter.emit(ReplayerEvents.Start);\n  }\n  pause(timeOffset) {\n    var _a, _b;\n    if (timeOffset === undefined && this.service.state.matches('playing')) {\n      this.service.send({\n        type: 'PAUSE'\n      });\n    }\n    if (typeof timeOffset === 'number') {\n      this.play(timeOffset);\n      this.service.send({\n        type: 'PAUSE'\n      });\n    }\n    (_b = (_a = this.iframe.contentDocument) === null || _a === void 0 ? void 0 : _a.getElementsByTagName('html')[0]) === null || _b === void 0 ? void 0 : _b.classList.add('rrweb-paused');\n    this.emitter.emit(ReplayerEvents.Pause);\n  }\n  resume(timeOffset = 0) {\n    console.warn(`The 'resume' was deprecated in 1.0. Please use 'play' method which has the same interface.`);\n    this.play(timeOffset);\n    this.emitter.emit(ReplayerEvents.Resume);\n  }\n  destroy() {\n    this.pause();\n    this.config.root.removeChild(this.wrapper);\n    this.emitter.emit(ReplayerEvents.Destroy);\n  }\n  startLive(baselineTime) {\n    this.service.send({\n      type: 'TO_LIVE',\n      payload: {\n        baselineTime\n      }\n    });\n  }\n  addEvent(rawEvent) {\n    const event = this.config.unpackFn ? this.config.unpackFn(rawEvent) : rawEvent;\n    if (indicatesTouchDevice(event)) {\n      this.mouse.classList.add('touch-device');\n    }\n    void Promise.resolve().then(() => this.service.send({\n      type: 'ADD_EVENT',\n      payload: {\n        event\n      }\n    }));\n  }\n  enableInteract() {\n    this.iframe.setAttribute('scrolling', 'auto');\n    this.iframe.style.pointerEvents = 'auto';\n  }\n  disableInteract() {\n    this.iframe.setAttribute('scrolling', 'no');\n    this.iframe.style.pointerEvents = 'none';\n  }\n  resetCache() {\n    this.cache = createCache();\n  }\n  setupDom() {\n    this.wrapper = document.createElement('div');\n    this.wrapper.classList.add('replayer-wrapper');\n    this.config.root.appendChild(this.wrapper);\n    this.mouse = document.createElement('div');\n    this.mouse.classList.add('replayer-mouse');\n    this.wrapper.appendChild(this.mouse);\n    if (this.config.mouseTail !== false) {\n      this.mouseTail = document.createElement('canvas');\n      this.mouseTail.classList.add('replayer-mouse-tail');\n      this.mouseTail.style.display = 'inherit';\n      this.wrapper.appendChild(this.mouseTail);\n    }\n    this.iframe = document.createElement('iframe');\n    const attributes = ['allow-same-origin'];\n    if (this.config.UNSAFE_replayCanvas) {\n      attributes.push('allow-scripts');\n    }\n    this.iframe.style.display = 'none';\n    this.iframe.setAttribute('sandbox', attributes.join(' '));\n    this.disableInteract();\n    this.wrapper.appendChild(this.iframe);\n    if (this.iframe.contentWindow && this.iframe.contentDocument) {\n      polyfill(this.iframe.contentWindow, this.iframe.contentDocument);\n      polyfill$1(this.iframe.contentWindow);\n    }\n  }\n  rebuildFullSnapshot(event, isSync = false) {\n    if (!this.iframe.contentDocument) {\n      return console.warn('Looks like your replayer has been destroyed.');\n    }\n    if (Object.keys(this.legacy_missingNodeRetryMap).length) {\n      console.warn('Found unresolved missing node map', this.legacy_missingNodeRetryMap);\n    }\n    this.legacy_missingNodeRetryMap = {};\n    const collected = [];\n    const afterAppend = (builtNode, id) => {\n      this.collectIframeAndAttachDocument(collected, builtNode);\n      for (const plugin of this.config.plugins || []) {\n        if (plugin.onBuild) plugin.onBuild(builtNode, {\n          id,\n          replayer: this\n        });\n      }\n    };\n    rebuild(event.data.node, {\n      doc: this.iframe.contentDocument,\n      afterAppend,\n      cache: this.cache,\n      mirror: this.mirror\n    });\n    afterAppend(this.iframe.contentDocument, event.data.node.id);\n    for (const {\n      mutationInQueue,\n      builtNode\n    } of collected) {\n      this.attachDocumentToIframe(mutationInQueue, builtNode);\n      this.newDocumentQueue = this.newDocumentQueue.filter(m => m !== mutationInQueue);\n    }\n    const {\n      documentElement,\n      head\n    } = this.iframe.contentDocument;\n    this.insertStyleRules(documentElement, head);\n    if (!this.service.state.matches('playing')) {\n      this.iframe.contentDocument.getElementsByTagName('html')[0].classList.add('rrweb-paused');\n    }\n    this.emitter.emit(ReplayerEvents.FullsnapshotRebuilded, event);\n    if (!isSync) {\n      this.waitForStylesheetLoad();\n    }\n    if (this.config.UNSAFE_replayCanvas) {\n      void this.preloadAllImages();\n    }\n  }\n  insertStyleRules(documentElement, head) {\n    var _a;\n    const injectStylesRules = rules(this.config.blockClass).concat(this.config.insertStyleRules);\n    if (this.config.pauseAnimation) {\n      injectStylesRules.push('html.rrweb-paused *, html.rrweb-paused *:before, html.rrweb-paused *:after { animation-play-state: paused !important; }');\n    }\n    if (this.usingVirtualDom) {\n      const styleEl = this.virtualDom.createElement('style');\n      this.virtualDom.mirror.add(styleEl, getDefaultSN(styleEl, this.virtualDom.unserializedId));\n      documentElement.insertBefore(styleEl, head);\n      styleEl.rules.push({\n        source: IncrementalSource.StyleSheetRule,\n        adds: injectStylesRules.map((cssText, index) => ({\n          rule: cssText,\n          index\n        }))\n      });\n    } else {\n      const styleEl = document.createElement('style');\n      documentElement.insertBefore(styleEl, head);\n      for (let idx = 0; idx < injectStylesRules.length; idx++) {\n        (_a = styleEl.sheet) === null || _a === void 0 ? void 0 : _a.insertRule(injectStylesRules[idx], idx);\n      }\n    }\n  }\n  attachDocumentToIframe(mutation, iframeEl) {\n    const mirror = this.usingVirtualDom ? this.virtualDom.mirror : this.mirror;\n    const collected = [];\n    const afterAppend = (builtNode, id) => {\n      this.collectIframeAndAttachDocument(collected, builtNode);\n      const sn = mirror.getMeta(builtNode);\n      if ((sn === null || sn === void 0 ? void 0 : sn.type) === NodeType.Element && (sn === null || sn === void 0 ? void 0 : sn.tagName.toUpperCase()) === 'HTML') {\n        const {\n          documentElement,\n          head\n        } = iframeEl.contentDocument;\n        this.insertStyleRules(documentElement, head);\n      }\n      for (const plugin of this.config.plugins || []) {\n        if (plugin.onBuild) plugin.onBuild(builtNode, {\n          id,\n          replayer: this\n        });\n      }\n    };\n    buildNodeWithSN(mutation.node, {\n      doc: iframeEl.contentDocument,\n      mirror: mirror,\n      hackCss: true,\n      skipChild: false,\n      afterAppend,\n      cache: this.cache\n    });\n    afterAppend(iframeEl.contentDocument, mutation.node.id);\n    for (const {\n      mutationInQueue,\n      builtNode\n    } of collected) {\n      this.attachDocumentToIframe(mutationInQueue, builtNode);\n      this.newDocumentQueue = this.newDocumentQueue.filter(m => m !== mutationInQueue);\n    }\n  }\n  collectIframeAndAttachDocument(collected, builtNode) {\n    if (isSerializedIframe(builtNode, this.mirror)) {\n      const mutationInQueue = this.newDocumentQueue.find(m => m.parentId === this.mirror.getId(builtNode));\n      if (mutationInQueue) {\n        collected.push({\n          mutationInQueue,\n          builtNode: builtNode\n        });\n      }\n    }\n  }\n  waitForStylesheetLoad() {\n    var _a;\n    const head = (_a = this.iframe.contentDocument) === null || _a === void 0 ? void 0 : _a.head;\n    if (head) {\n      const unloadSheets = new Set();\n      let timer;\n      let beforeLoadState = this.service.state;\n      const stateHandler = () => {\n        beforeLoadState = this.service.state;\n      };\n      this.emitter.on(ReplayerEvents.Start, stateHandler);\n      this.emitter.on(ReplayerEvents.Pause, stateHandler);\n      const unsubscribe = () => {\n        this.emitter.off(ReplayerEvents.Start, stateHandler);\n        this.emitter.off(ReplayerEvents.Pause, stateHandler);\n      };\n      head.querySelectorAll('link[rel=\"stylesheet\"]').forEach(css => {\n        if (!css.sheet) {\n          unloadSheets.add(css);\n          css.addEventListener('load', () => {\n            unloadSheets.delete(css);\n            if (unloadSheets.size === 0 && timer !== -1) {\n              if (beforeLoadState.matches('playing')) {\n                this.play(this.getCurrentTime());\n              }\n              this.emitter.emit(ReplayerEvents.LoadStylesheetEnd);\n              if (timer) {\n                clearTimeout(timer);\n              }\n              unsubscribe();\n            }\n          });\n        }\n      });\n      if (unloadSheets.size > 0) {\n        this.service.send({\n          type: 'PAUSE'\n        });\n        this.emitter.emit(ReplayerEvents.LoadStylesheetStart);\n        timer = setTimeout(() => {\n          if (beforeLoadState.matches('playing')) {\n            this.play(this.getCurrentTime());\n          }\n          timer = -1;\n          unsubscribe();\n        }, this.config.loadTimeout);\n      }\n    }\n  }\n  preloadAllImages() {\n    return __awaiter(this, void 0, void 0, function* () {\n      this.service.state;\n      const stateHandler = () => {\n        this.service.state;\n      };\n      this.emitter.on(ReplayerEvents.Start, stateHandler);\n      this.emitter.on(ReplayerEvents.Pause, stateHandler);\n      const promises = [];\n      for (const event of this.service.state.context.events) {\n        if (event.type === EventType.IncrementalSnapshot && event.data.source === IncrementalSource.CanvasMutation) {\n          promises.push(this.deserializeAndPreloadCanvasEvents(event.data, event));\n          const commands = 'commands' in event.data ? event.data.commands : [event.data];\n          commands.forEach(c => {\n            this.preloadImages(c, event);\n          });\n        }\n      }\n      return Promise.all(promises);\n    });\n  }\n  preloadImages(data, event) {\n    if (data.property === 'drawImage' && typeof data.args[0] === 'string' && !this.imageMap.has(event)) {\n      const canvas = document.createElement('canvas');\n      const ctx = canvas.getContext('2d');\n      const imgd = ctx === null || ctx === void 0 ? void 0 : ctx.createImageData(canvas.width, canvas.height);\n      imgd === null || imgd === void 0 ? void 0 : imgd.data;\n      JSON.parse(data.args[0]);\n      ctx === null || ctx === void 0 ? void 0 : ctx.putImageData(imgd, 0, 0);\n    }\n  }\n  deserializeAndPreloadCanvasEvents(data, event) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!this.canvasEventMap.has(event)) {\n        const status = {\n          isUnchanged: true\n        };\n        if ('commands' in data) {\n          const commands = yield Promise.all(data.commands.map(c => __awaiter(this, void 0, void 0, function* () {\n            const args = yield Promise.all(c.args.map(deserializeArg(this.imageMap, null, status)));\n            return Object.assign(Object.assign({}, c), {\n              args\n            });\n          })));\n          if (status.isUnchanged === false) this.canvasEventMap.set(event, Object.assign(Object.assign({}, data), {\n            commands\n          }));\n        } else {\n          const args = yield Promise.all(data.args.map(deserializeArg(this.imageMap, null, status)));\n          if (status.isUnchanged === false) this.canvasEventMap.set(event, Object.assign(Object.assign({}, data), {\n            args\n          }));\n        }\n      }\n    });\n  }\n  applyIncremental(e, isSync) {\n    var _a, _b, _c;\n    const {\n      data: d\n    } = e;\n    switch (d.source) {\n      case IncrementalSource.Mutation:\n        {\n          try {\n            this.applyMutation(d, isSync);\n          } catch (error) {\n            this.warn(`Exception in mutation ${error.message || error}`, d);\n          }\n          break;\n        }\n      case IncrementalSource.Drag:\n      case IncrementalSource.TouchMove:\n      case IncrementalSource.MouseMove:\n        if (isSync) {\n          const lastPosition = d.positions[d.positions.length - 1];\n          this.mousePos = {\n            x: lastPosition.x,\n            y: lastPosition.y,\n            id: lastPosition.id,\n            debugData: d\n          };\n        } else {\n          d.positions.forEach(p => {\n            const action = {\n              doAction: () => {\n                this.moveAndHover(p.x, p.y, p.id, isSync, d);\n              },\n              delay: p.timeOffset + e.timestamp - this.service.state.context.baselineTime\n            };\n            this.timer.addAction(action);\n          });\n          this.timer.addAction({\n            doAction() {},\n            delay: e.delay - ((_a = d.positions[0]) === null || _a === void 0 ? void 0 : _a.timeOffset)\n          });\n        }\n        break;\n      case IncrementalSource.MouseInteraction:\n        {\n          if (d.id === -1 || isSync) {\n            break;\n          }\n          const event = new Event(MouseInteractions[d.type].toLowerCase());\n          const target = this.mirror.getNode(d.id);\n          if (!target) {\n            return this.debugNodeNotFound(d, d.id);\n          }\n          this.emitter.emit(ReplayerEvents.MouseInteraction, {\n            type: d.type,\n            target\n          });\n          const {\n            triggerFocus\n          } = this.config;\n          switch (d.type) {\n            case MouseInteractions.Blur:\n              if ('blur' in target) {\n                target.blur();\n              }\n              break;\n            case MouseInteractions.Focus:\n              if (triggerFocus && target.focus) {\n                target.focus({\n                  preventScroll: true\n                });\n              }\n              break;\n            case MouseInteractions.Click:\n            case MouseInteractions.TouchStart:\n            case MouseInteractions.TouchEnd:\n              if (isSync) {\n                if (d.type === MouseInteractions.TouchStart) {\n                  this.touchActive = true;\n                } else if (d.type === MouseInteractions.TouchEnd) {\n                  this.touchActive = false;\n                }\n                this.mousePos = {\n                  x: d.x,\n                  y: d.y,\n                  id: d.id,\n                  debugData: d\n                };\n              } else {\n                if (d.type === MouseInteractions.TouchStart) {\n                  this.tailPositions.length = 0;\n                }\n                this.moveAndHover(d.x, d.y, d.id, isSync, d);\n                if (d.type === MouseInteractions.Click) {\n                  this.mouse.classList.remove('active');\n                  void this.mouse.offsetWidth;\n                  this.mouse.classList.add('active');\n                } else if (d.type === MouseInteractions.TouchStart) {\n                  void this.mouse.offsetWidth;\n                  this.mouse.classList.add('touch-active');\n                } else if (d.type === MouseInteractions.TouchEnd) {\n                  this.mouse.classList.remove('touch-active');\n                }\n              }\n              break;\n            case MouseInteractions.TouchCancel:\n              if (isSync) {\n                this.touchActive = false;\n              } else {\n                this.mouse.classList.remove('touch-active');\n              }\n              break;\n            default:\n              target.dispatchEvent(event);\n          }\n          break;\n        }\n      case IncrementalSource.Scroll:\n        {\n          if (d.id === -1) {\n            break;\n          }\n          if (this.usingVirtualDom) {\n            const target = this.virtualDom.mirror.getNode(d.id);\n            if (!target) {\n              return this.debugNodeNotFound(d, d.id);\n            }\n            target.scrollData = d;\n            break;\n          }\n          this.applyScroll(d, isSync);\n          break;\n        }\n      case IncrementalSource.ViewportResize:\n        this.emitter.emit(ReplayerEvents.Resize, {\n          width: d.width,\n          height: d.height\n        });\n        break;\n      case IncrementalSource.Input:\n        {\n          if (d.id === -1) {\n            break;\n          }\n          if (this.usingVirtualDom) {\n            const target = this.virtualDom.mirror.getNode(d.id);\n            if (!target) {\n              return this.debugNodeNotFound(d, d.id);\n            }\n            target.inputData = d;\n            break;\n          }\n          this.applyInput(d);\n          break;\n        }\n      case IncrementalSource.MediaInteraction:\n        {\n          const target = this.usingVirtualDom ? this.virtualDom.mirror.getNode(d.id) : this.mirror.getNode(d.id);\n          if (!target) {\n            return this.debugNodeNotFound(d, d.id);\n          }\n          const mediaEl = target;\n          try {\n            if (d.currentTime) {\n              mediaEl.currentTime = d.currentTime;\n            }\n            if (d.volume) {\n              mediaEl.volume = d.volume;\n            }\n            if (d.muted) {\n              mediaEl.muted = d.muted;\n            }\n            if (d.type === 1) {\n              mediaEl.pause();\n            }\n            if (d.type === 0) {\n              void mediaEl.play();\n            }\n            if (d.type === 4) {\n              mediaEl.playbackRate = d.playbackRate;\n            }\n          } catch (error) {\n            if (this.config.showWarning) {\n              console.warn(`Failed to replay media interactions: ${error.message || error}`);\n            }\n          }\n          break;\n        }\n      case IncrementalSource.StyleSheetRule:\n      case IncrementalSource.StyleDeclaration:\n        {\n          if (this.usingVirtualDom) {\n            if (d.styleId) this.constructedStyleMutations.push(d);else if (d.id) (_b = this.virtualDom.mirror.getNode(d.id)) === null || _b === void 0 ? void 0 : _b.rules.push(d);\n          } else this.applyStyleSheetMutation(d);\n          break;\n        }\n      case IncrementalSource.CanvasMutation:\n        {\n          if (!this.config.UNSAFE_replayCanvas) {\n            return;\n          }\n          if (this.usingVirtualDom) {\n            const target = this.virtualDom.mirror.getNode(d.id);\n            if (!target) {\n              return this.debugNodeNotFound(d, d.id);\n            }\n            target.canvasMutations.push({\n              event: e,\n              mutation: d\n            });\n          } else {\n            const target = this.mirror.getNode(d.id);\n            if (!target) {\n              return this.debugNodeNotFound(d, d.id);\n            }\n            void canvasMutation({\n              event: e,\n              mutation: d,\n              target: target,\n              imageMap: this.imageMap,\n              canvasEventMap: this.canvasEventMap,\n              errorHandler: this.warnCanvasMutationFailed.bind(this)\n            });\n          }\n          break;\n        }\n      case IncrementalSource.Font:\n        {\n          try {\n            const fontFace = new FontFace(d.family, d.buffer ? new Uint8Array(JSON.parse(d.fontSource)) : d.fontSource, d.descriptors);\n            (_c = this.iframe.contentDocument) === null || _c === void 0 ? void 0 : _c.fonts.add(fontFace);\n          } catch (error) {\n            if (this.config.showWarning) {\n              console.warn(error);\n            }\n          }\n          break;\n        }\n      case IncrementalSource.Selection:\n        {\n          if (isSync) {\n            this.lastSelectionData = d;\n            break;\n          }\n          this.applySelection(d);\n          break;\n        }\n      case IncrementalSource.AdoptedStyleSheet:\n        {\n          if (this.usingVirtualDom) this.adoptedStyleSheets.push(d);else this.applyAdoptedStyleSheet(d);\n          break;\n        }\n    }\n  }\n  applyMutation(d, isSync) {\n    if (this.config.useVirtualDom && !this.usingVirtualDom && isSync) {\n      this.usingVirtualDom = true;\n      buildFromDom(this.iframe.contentDocument, this.mirror, this.virtualDom);\n      if (Object.keys(this.legacy_missingNodeRetryMap).length) {\n        for (const key in this.legacy_missingNodeRetryMap) {\n          try {\n            const value = this.legacy_missingNodeRetryMap[key];\n            const virtualNode = buildFromNode(value.node, this.virtualDom, this.mirror);\n            if (virtualNode) value.node = virtualNode;\n          } catch (error) {\n            if (this.config.showWarning) {\n              console.warn(error);\n            }\n          }\n        }\n      }\n    }\n    const mirror = this.usingVirtualDom ? this.virtualDom.mirror : this.mirror;\n    d.removes.forEach(mutation => {\n      var _a;\n      const target = mirror.getNode(mutation.id);\n      if (!target) {\n        if (d.removes.find(r => r.id === mutation.parentId)) {\n          return;\n        }\n        return this.warnNodeNotFound(d, mutation.id);\n      }\n      let parent = mirror.getNode(mutation.parentId);\n      if (!parent) {\n        return this.warnNodeNotFound(d, mutation.parentId);\n      }\n      if (mutation.isShadow && hasShadowRoot(parent)) {\n        parent = parent.shadowRoot;\n      }\n      mirror.removeNodeFromMap(target);\n      if (parent) try {\n        parent.removeChild(target);\n        if (this.usingVirtualDom && target.nodeName === '#text' && parent.nodeName === 'STYLE' && ((_a = parent.rules) === null || _a === void 0 ? void 0 : _a.length) > 0) parent.rules = [];\n      } catch (error) {\n        if (error instanceof DOMException) {\n          this.warn('parent could not remove child in mutation', parent, target, d);\n        } else {\n          throw error;\n        }\n      }\n    });\n    const legacy_missingNodeMap = Object.assign({}, this.legacy_missingNodeRetryMap);\n    const queue = [];\n    const nextNotInDOM = mutation => {\n      let next = null;\n      if (mutation.nextId) {\n        next = mirror.getNode(mutation.nextId);\n      }\n      if (mutation.nextId !== null && mutation.nextId !== undefined && mutation.nextId !== -1 && !next) {\n        return true;\n      }\n      return false;\n    };\n    const appendNode = mutation => {\n      var _a;\n      if (!this.iframe.contentDocument) {\n        return console.warn('Looks like your replayer has been destroyed.');\n      }\n      let parent = mirror.getNode(mutation.parentId);\n      if (!parent) {\n        if (mutation.node.type === NodeType.Document) {\n          return this.newDocumentQueue.push(mutation);\n        }\n        return queue.push(mutation);\n      }\n      if (mutation.node.isShadow) {\n        if (!hasShadowRoot(parent)) {\n          parent.attachShadow({\n            mode: 'open'\n          });\n          parent = parent.shadowRoot;\n        } else parent = parent.shadowRoot;\n      }\n      let previous = null;\n      let next = null;\n      if (mutation.previousId) {\n        previous = mirror.getNode(mutation.previousId);\n      }\n      if (mutation.nextId) {\n        next = mirror.getNode(mutation.nextId);\n      }\n      if (nextNotInDOM(mutation)) {\n        return queue.push(mutation);\n      }\n      if (mutation.node.rootId && !mirror.getNode(mutation.node.rootId)) {\n        return;\n      }\n      const targetDoc = mutation.node.rootId ? mirror.getNode(mutation.node.rootId) : this.usingVirtualDom ? this.virtualDom : this.iframe.contentDocument;\n      if (isSerializedIframe(parent, mirror)) {\n        this.attachDocumentToIframe(mutation, parent);\n        return;\n      }\n      const afterAppend = (node, id) => {\n        for (const plugin of this.config.plugins || []) {\n          if (plugin.onBuild) plugin.onBuild(node, {\n            id,\n            replayer: this\n          });\n        }\n      };\n      const target = buildNodeWithSN(mutation.node, {\n        doc: targetDoc,\n        mirror: mirror,\n        skipChild: true,\n        hackCss: true,\n        cache: this.cache,\n        afterAppend\n      });\n      if (mutation.previousId === -1 || mutation.nextId === -1) {\n        legacy_missingNodeMap[mutation.node.id] = {\n          node: target,\n          mutation\n        };\n        return;\n      }\n      const parentSn = mirror.getMeta(parent);\n      if (parentSn && parentSn.type === NodeType.Element && parentSn.tagName === 'textarea' && mutation.node.type === NodeType.Text) {\n        const childNodeArray = Array.isArray(parent.childNodes) ? parent.childNodes : Array.from(parent.childNodes);\n        for (const c of childNodeArray) {\n          if (c.nodeType === parent.TEXT_NODE) {\n            parent.removeChild(c);\n          }\n        }\n      }\n      if (previous && previous.nextSibling && previous.nextSibling.parentNode) {\n        parent.insertBefore(target, previous.nextSibling);\n      } else if (next && next.parentNode) {\n        parent.contains(next) ? parent.insertBefore(target, next) : parent.insertBefore(target, null);\n      } else {\n        if (parent === targetDoc) {\n          while (targetDoc.firstChild) {\n            targetDoc.removeChild(targetDoc.firstChild);\n          }\n        }\n        parent.appendChild(target);\n      }\n      afterAppend(target, mutation.node.id);\n      if (this.usingVirtualDom && target.nodeName === '#text' && parent.nodeName === 'STYLE' && ((_a = parent.rules) === null || _a === void 0 ? void 0 : _a.length) > 0) parent.rules = [];\n      if (isSerializedIframe(target, this.mirror)) {\n        const targetId = this.mirror.getId(target);\n        const mutationInQueue = this.newDocumentQueue.find(m => m.parentId === targetId);\n        if (mutationInQueue) {\n          this.attachDocumentToIframe(mutationInQueue, target);\n          this.newDocumentQueue = this.newDocumentQueue.filter(m => m !== mutationInQueue);\n        }\n      }\n      if (mutation.previousId || mutation.nextId) {\n        this.legacy_resolveMissingNode(legacy_missingNodeMap, parent, target, mutation);\n      }\n    };\n    d.adds.forEach(mutation => {\n      appendNode(mutation);\n    });\n    const startTime = Date.now();\n    while (queue.length) {\n      const resolveTrees = queueToResolveTrees(queue);\n      queue.length = 0;\n      if (Date.now() - startTime > 500) {\n        this.warn('Timeout in the loop, please check the resolve tree data:', resolveTrees);\n        break;\n      }\n      for (const tree of resolveTrees) {\n        const parent = mirror.getNode(tree.value.parentId);\n        if (!parent) {\n          this.debug('Drop resolve tree since there is no parent for the root node.', tree);\n        } else {\n          iterateResolveTree(tree, mutation => {\n            appendNode(mutation);\n          });\n        }\n      }\n    }\n    if (Object.keys(legacy_missingNodeMap).length) {\n      Object.assign(this.legacy_missingNodeRetryMap, legacy_missingNodeMap);\n    }\n    uniqueTextMutations(d.texts).forEach(mutation => {\n      var _a;\n      const target = mirror.getNode(mutation.id);\n      if (!target) {\n        if (d.removes.find(r => r.id === mutation.id)) {\n          return;\n        }\n        return this.warnNodeNotFound(d, mutation.id);\n      }\n      target.textContent = mutation.value;\n      if (this.usingVirtualDom) {\n        const parent = target.parentNode;\n        if (((_a = parent === null || parent === void 0 ? void 0 : parent.rules) === null || _a === void 0 ? void 0 : _a.length) > 0) parent.rules = [];\n      }\n    });\n    d.attributes.forEach(mutation => {\n      const target = mirror.getNode(mutation.id);\n      if (!target) {\n        if (d.removes.find(r => r.id === mutation.id)) {\n          return;\n        }\n        return this.warnNodeNotFound(d, mutation.id);\n      }\n      for (const attributeName in mutation.attributes) {\n        if (typeof attributeName === 'string') {\n          const value = mutation.attributes[attributeName];\n          if (value === null) {\n            target.removeAttribute(attributeName);\n          } else if (typeof value === 'string') {\n            try {\n              if (attributeName === '_cssText' && (target.nodeName === 'LINK' || target.nodeName === 'STYLE')) {\n                try {\n                  const newSn = mirror.getMeta(target);\n                  Object.assign(newSn.attributes, mutation.attributes);\n                  const newNode = buildNodeWithSN(newSn, {\n                    doc: target.ownerDocument,\n                    mirror: mirror,\n                    skipChild: true,\n                    hackCss: true,\n                    cache: this.cache\n                  });\n                  const siblingNode = target.nextSibling;\n                  const parentNode = target.parentNode;\n                  if (newNode && parentNode) {\n                    parentNode.removeChild(target);\n                    parentNode.insertBefore(newNode, siblingNode);\n                    mirror.replace(mutation.id, newNode);\n                    break;\n                  }\n                } catch (e) {}\n              }\n              target.setAttribute(attributeName, value);\n            } catch (error) {\n              if (this.config.showWarning) {\n                console.warn('An error occurred may due to the checkout feature.', error);\n              }\n            }\n          } else if (attributeName === 'style') {\n            const styleValues = value;\n            const targetEl = target;\n            for (const s in styleValues) {\n              if (styleValues[s] === false) {\n                targetEl.style.removeProperty(s);\n              } else if (styleValues[s] instanceof Array) {\n                const svp = styleValues[s];\n                targetEl.style.setProperty(s, svp[0], svp[1]);\n              } else {\n                const svs = styleValues[s];\n                targetEl.style.setProperty(s, svs);\n              }\n            }\n          }\n        }\n      }\n    });\n  }\n  applyScroll(d, isSync) {\n    var _a, _b;\n    const target = this.mirror.getNode(d.id);\n    if (!target) {\n      return this.debugNodeNotFound(d, d.id);\n    }\n    const sn = this.mirror.getMeta(target);\n    if (target === this.iframe.contentDocument) {\n      (_a = this.iframe.contentWindow) === null || _a === void 0 ? void 0 : _a.scrollTo({\n        top: d.y,\n        left: d.x,\n        behavior: isSync ? 'auto' : 'smooth'\n      });\n    } else if ((sn === null || sn === void 0 ? void 0 : sn.type) === NodeType.Document) {\n      (_b = target.defaultView) === null || _b === void 0 ? void 0 : _b.scrollTo({\n        top: d.y,\n        left: d.x,\n        behavior: isSync ? 'auto' : 'smooth'\n      });\n    } else {\n      try {\n        target.scrollTo({\n          top: d.y,\n          left: d.x,\n          behavior: isSync ? 'auto' : 'smooth'\n        });\n      } catch (error) {}\n    }\n  }\n  applyInput(d) {\n    const target = this.mirror.getNode(d.id);\n    if (!target) {\n      return this.debugNodeNotFound(d, d.id);\n    }\n    try {\n      target.checked = d.isChecked;\n      target.value = d.text;\n    } catch (error) {}\n  }\n  applySelection(d) {\n    try {\n      const selectionSet = new Set();\n      const ranges = d.ranges.map(({\n        start,\n        startOffset,\n        end,\n        endOffset\n      }) => {\n        const startContainer = this.mirror.getNode(start);\n        const endContainer = this.mirror.getNode(end);\n        if (!startContainer || !endContainer) return;\n        const result = new Range();\n        result.setStart(startContainer, startOffset);\n        result.setEnd(endContainer, endOffset);\n        const doc = startContainer.ownerDocument;\n        const selection = doc === null || doc === void 0 ? void 0 : doc.getSelection();\n        selection && selectionSet.add(selection);\n        return {\n          range: result,\n          selection\n        };\n      });\n      selectionSet.forEach(s => s.removeAllRanges());\n      ranges.forEach(r => {\n        var _a;\n        return r && ((_a = r.selection) === null || _a === void 0 ? void 0 : _a.addRange(r.range));\n      });\n    } catch (error) {}\n  }\n  applyStyleSheetMutation(data) {\n    var _a;\n    let styleSheet = null;\n    if (data.styleId) styleSheet = this.styleMirror.getStyle(data.styleId);else if (data.id) styleSheet = ((_a = this.mirror.getNode(data.id)) === null || _a === void 0 ? void 0 : _a.sheet) || null;\n    if (!styleSheet) return;\n    if (data.source === IncrementalSource.StyleSheetRule) this.applyStyleSheetRule(data, styleSheet);else if (data.source === IncrementalSource.StyleDeclaration) this.applyStyleDeclaration(data, styleSheet);\n  }\n  applyStyleSheetRule(data, styleSheet) {\n    var _a, _b, _c, _d;\n    (_a = data.adds) === null || _a === void 0 ? void 0 : _a.forEach(({\n      rule,\n      index: nestedIndex\n    }) => {\n      try {\n        if (Array.isArray(nestedIndex)) {\n          const {\n            positions,\n            index\n          } = getPositionsAndIndex(nestedIndex);\n          const nestedRule = getNestedRule(styleSheet.cssRules, positions);\n          nestedRule.insertRule(rule, index);\n        } else {\n          const index = nestedIndex === undefined ? undefined : Math.min(nestedIndex, styleSheet.cssRules.length);\n          styleSheet === null || styleSheet === void 0 ? void 0 : styleSheet.insertRule(rule, index);\n        }\n      } catch (e) {}\n    });\n    (_b = data.removes) === null || _b === void 0 ? void 0 : _b.forEach(({\n      index: nestedIndex\n    }) => {\n      try {\n        if (Array.isArray(nestedIndex)) {\n          const {\n            positions,\n            index\n          } = getPositionsAndIndex(nestedIndex);\n          const nestedRule = getNestedRule(styleSheet.cssRules, positions);\n          nestedRule.deleteRule(index || 0);\n        } else {\n          styleSheet === null || styleSheet === void 0 ? void 0 : styleSheet.deleteRule(nestedIndex);\n        }\n      } catch (e) {}\n    });\n    if (data.replace) try {\n      void ((_c = styleSheet.replace) === null || _c === void 0 ? void 0 : _c.call(styleSheet, data.replace));\n    } catch (e) {}\n    if (data.replaceSync) try {\n      (_d = styleSheet.replaceSync) === null || _d === void 0 ? void 0 : _d.call(styleSheet, data.replaceSync);\n    } catch (e) {}\n  }\n  applyStyleDeclaration(data, styleSheet) {\n    if (data.set) {\n      const rule = getNestedRule(styleSheet.rules, data.index);\n      rule.style.setProperty(data.set.property, data.set.value, data.set.priority);\n    }\n    if (data.remove) {\n      const rule = getNestedRule(styleSheet.rules, data.index);\n      rule.style.removeProperty(data.remove.property);\n    }\n  }\n  applyAdoptedStyleSheet(data) {\n    var _a;\n    const targetHost = this.mirror.getNode(data.id);\n    if (!targetHost) return;\n    (_a = data.styles) === null || _a === void 0 ? void 0 : _a.forEach(style => {\n      var _a;\n      let newStyleSheet = null;\n      let hostWindow = null;\n      if (hasShadowRoot(targetHost)) hostWindow = ((_a = targetHost.ownerDocument) === null || _a === void 0 ? void 0 : _a.defaultView) || null;else if (targetHost.nodeName === '#document') hostWindow = targetHost.defaultView;\n      if (!hostWindow) return;\n      try {\n        newStyleSheet = new hostWindow.CSSStyleSheet();\n        this.styleMirror.add(newStyleSheet, style.styleId);\n        this.applyStyleSheetRule({\n          source: IncrementalSource.StyleSheetRule,\n          adds: style.rules\n        }, newStyleSheet);\n      } catch (e) {}\n    });\n    const MAX_RETRY_TIME = 10;\n    let count = 0;\n    const adoptStyleSheets = (targetHost, styleIds) => {\n      const stylesToAdopt = styleIds.map(styleId => this.styleMirror.getStyle(styleId)).filter(style => style !== null);\n      if (hasShadowRoot(targetHost)) targetHost.shadowRoot.adoptedStyleSheets = stylesToAdopt;else if (targetHost.nodeName === '#document') targetHost.adoptedStyleSheets = stylesToAdopt;\n      if (stylesToAdopt.length !== styleIds.length && count < MAX_RETRY_TIME) {\n        setTimeout(() => adoptStyleSheets(targetHost, styleIds), 0 + 100 * count);\n        count++;\n      }\n    };\n    adoptStyleSheets(targetHost, data.styleIds);\n  }\n  legacy_resolveMissingNode(map, parent, target, targetMutation) {\n    const {\n      previousId,\n      nextId\n    } = targetMutation;\n    const previousInMap = previousId && map[previousId];\n    const nextInMap = nextId && map[nextId];\n    if (previousInMap) {\n      const {\n        node,\n        mutation\n      } = previousInMap;\n      parent.insertBefore(node, target);\n      delete map[mutation.node.id];\n      delete this.legacy_missingNodeRetryMap[mutation.node.id];\n      if (mutation.previousId || mutation.nextId) {\n        this.legacy_resolveMissingNode(map, parent, node, mutation);\n      }\n    }\n    if (nextInMap) {\n      const {\n        node,\n        mutation\n      } = nextInMap;\n      parent.insertBefore(node, target.nextSibling);\n      delete map[mutation.node.id];\n      delete this.legacy_missingNodeRetryMap[mutation.node.id];\n      if (mutation.previousId || mutation.nextId) {\n        this.legacy_resolveMissingNode(map, parent, node, mutation);\n      }\n    }\n  }\n  moveAndHover(x, y, id, isSync, debugData) {\n    const target = this.mirror.getNode(id);\n    if (!target) {\n      return this.debugNodeNotFound(debugData, id);\n    }\n    const base = getBaseDimension(target, this.iframe);\n    const _x = x * base.absoluteScale + base.x;\n    const _y = y * base.absoluteScale + base.y;\n    this.mouse.style.left = `${_x}px`;\n    this.mouse.style.top = `${_y}px`;\n    if (!isSync) {\n      this.drawMouseTail({\n        x: _x,\n        y: _y\n      });\n    }\n    this.hoverElements(target);\n  }\n  drawMouseTail(position) {\n    if (!this.mouseTail) {\n      return;\n    }\n    const {\n      lineCap,\n      lineWidth,\n      strokeStyle,\n      duration\n    } = this.config.mouseTail === true ? defaultMouseTailConfig : Object.assign({}, defaultMouseTailConfig, this.config.mouseTail);\n    const draw = () => {\n      if (!this.mouseTail) {\n        return;\n      }\n      const ctx = this.mouseTail.getContext('2d');\n      if (!ctx || !this.tailPositions.length) {\n        return;\n      }\n      ctx.clearRect(0, 0, this.mouseTail.width, this.mouseTail.height);\n      ctx.beginPath();\n      ctx.lineWidth = lineWidth;\n      ctx.lineCap = lineCap;\n      ctx.strokeStyle = strokeStyle;\n      ctx.moveTo(this.tailPositions[0].x, this.tailPositions[0].y);\n      this.tailPositions.forEach(p => ctx.lineTo(p.x, p.y));\n      ctx.stroke();\n    };\n    this.tailPositions.push(position);\n    draw();\n    setTimeout(() => {\n      this.tailPositions = this.tailPositions.filter(p => p !== position);\n      draw();\n    }, duration / this.speedService.state.context.timer.speed);\n  }\n  hoverElements(el) {\n    var _a;\n    (_a = this.iframe.contentDocument) === null || _a === void 0 ? void 0 : _a.querySelectorAll('.\\\\:hover').forEach(hoveredEl => {\n      hoveredEl.classList.remove(':hover');\n    });\n    let currentEl = el;\n    while (currentEl) {\n      if (currentEl.classList) {\n        currentEl.classList.add(':hover');\n      }\n      currentEl = currentEl.parentElement;\n    }\n  }\n  isUserInteraction(event) {\n    if (event.type !== EventType.IncrementalSnapshot) {\n      return false;\n    }\n    return event.data.source > IncrementalSource.Mutation && event.data.source <= IncrementalSource.Input;\n  }\n  backToNormal() {\n    this.nextUserInteractionEvent = null;\n    if (this.speedService.state.matches('normal')) {\n      return;\n    }\n    this.speedService.send({\n      type: 'BACK_TO_NORMAL'\n    });\n    this.emitter.emit(ReplayerEvents.SkipEnd, {\n      speed: this.speedService.state.context.normalSpeed\n    });\n  }\n  warnNodeNotFound(d, id) {\n    this.warn(`Node with id '${id}' not found. `, d);\n  }\n  warnCanvasMutationFailed(d, error) {\n    this.warn(`Has error on canvas update`, error, 'canvas mutation:', d);\n  }\n  debugNodeNotFound(d, id) {\n    this.debug(REPLAY_CONSOLE_PREFIX, `Node with id '${id}' not found. `, d);\n  }\n  warn(...args) {\n    if (!this.config.showWarning) {\n      return;\n    }\n    console.warn(REPLAY_CONSOLE_PREFIX, ...args);\n  }\n  debug(...args) {\n    if (!this.config.showDebug) {\n      return;\n    }\n    console.log(REPLAY_CONSOLE_PREFIX, ...args);\n  }\n}\nexport { Replayer };","map":{"version":3,"names":["__awaiter","createCache","createMirror","rebuild","buildNodeWithSN","NodeType","RRDocument","diff","createOrGetNode","getDefaultSN","buildFromDom","buildFromNode","mitt$1","mitt$2","polyfill","Timer","createPlayerService","createSpeedService","EventType","ReplayerEvents","IncrementalSource","MouseInteractions","StyleSheetMirror","polyfill$1","isSerializedIframe","hasShadowRoot","queueToResolveTrees","iterateResolveTree","uniqueTextMutations","getPositionsAndIndex","getNestedRule","getBaseDimension","rules","canvasMutation","deserializeArg","SKIP_TIME_THRESHOLD","SKIP_TIME_INTERVAL","mitt","REPLAY_CONSOLE_PREFIX","defaultMouseTailConfig","duration","lineCap","lineWidth","strokeStyle","indicatesTouchDevice","e","type","IncrementalSnapshot","data","source","TouchMove","MouseInteraction","TouchStart","Replayer","constructor","events","config","usingVirtualDom","virtualDom","mouseTail","tailPositions","emitter","legacy_missingNodeRetryMap","cache","imageMap","Map","canvasEventMap","mirror","styleMirror","firstFullSnapshot","newDocumentQueue","mousePos","touchActive","lastSelectionData","constructedStyleMutations","adoptedStyleSheets","handleResize","dimension","iframe","style","display","el","setAttribute","String","width","height","applyEventsSynchronously","event","DomContentLoaded","Load","Custom","FullSnapshot","Meta","Plugin","castFn","getCastFn","mouse","classList","add","remove","isSync","emit","CustomEvent","Resize","_a","rebuildFullSnapshot","contentWindow","scrollTo","initialOffset","reset","applyIncremental","nextUserInteractionEvent","backToNormal","skipInactive","_event","service","state","context","timestamp","isUserInteraction","delay","speedService","timer","speed","skipTime","payload","Math","min","round","maxSpeed","send","SkipStart","wrappedCastFn","plugin","plugins","handler","replayer","last_index","length","finish","Finish","MouseMove","positions","setTimeout","max","timeOffset","EventCast","liveMode","Error","defaultConfig","root","document","body","loadTimeout","showWarning","showDebug","blockClass","insertStyleRules","triggerFocus","UNSAFE_replayCanvas","pauseAnimation","useVirtualDom","Object","assign","bind","on","setupDom","getMirror","nodeMirror","Flush","replayerHandler","applyCanvas","canvasEvent","canvasMutationData","target","mutation","errorHandler","warnCanvasMutationFailed","applyInput","applyScroll","applyStyleSheetMutation","styleSheet","StyleSheetRule","applyStyleSheetRule","StyleDeclaration","applyStyleDeclaration","contentDocument","destroyTree","keys","key","value","realNode","node","error","console","warn","forEach","applyAdoptedStyleSheet","moveAndHover","x","y","id","debugData","applySelection","PlayBack","map","unpackFn","sort","a1","a2","baselineTime","lastPlayedEvent","start","subscribe","StateChange","player","normalSpeed","firstMeta","find","firstFullsnapshot","off","setConfig","createElement","Number","parseFloat","wrapper","insertBefore","getMetaData","firstEvent","lastEvent","startTime","endTime","totalTime","getCurrentTime","getTimeOffset","play","_b","matches","getElementsByTagName","Start","pause","undefined","Pause","resume","Resume","destroy","removeChild","Destroy","startLive","addEvent","rawEvent","Promise","resolve","then","enableInteract","pointerEvents","disableInteract","resetCache","appendChild","attributes","push","join","collected","afterAppend","builtNode","collectIframeAndAttachDocument","onBuild","doc","mutationInQueue","attachDocumentToIframe","filter","m","documentElement","head","FullsnapshotRebuilded","waitForStylesheetLoad","preloadAllImages","injectStylesRules","concat","styleEl","unserializedId","adds","cssText","index","rule","idx","sheet","insertRule","iframeEl","sn","getMeta","Element","tagName","toUpperCase","hackCss","skipChild","parentId","getId","unloadSheets","Set","beforeLoadState","stateHandler","unsubscribe","querySelectorAll","css","addEventListener","delete","size","LoadStylesheetEnd","clearTimeout","LoadStylesheetStart","promises","CanvasMutation","deserializeAndPreloadCanvasEvents","commands","c","preloadImages","all","property","args","has","canvas","ctx","getContext","imgd","createImageData","JSON","parse","putImageData","status","isUnchanged","set","_c","d","Mutation","applyMutation","message","Drag","lastPosition","p","action","doAction","addAction","Event","toLowerCase","getNode","debugNodeNotFound","Blur","blur","Focus","focus","preventScroll","Click","TouchEnd","offsetWidth","TouchCancel","dispatchEvent","Scroll","scrollData","ViewportResize","Input","inputData","MediaInteraction","mediaEl","currentTime","volume","muted","playbackRate","styleId","canvasMutations","Font","fontFace","FontFace","family","buffer","Uint8Array","fontSource","descriptors","fonts","Selection","AdoptedStyleSheet","virtualNode","removes","r","warnNodeNotFound","parent","isShadow","shadowRoot","removeNodeFromMap","nodeName","DOMException","legacy_missingNodeMap","queue","nextNotInDOM","next","nextId","appendNode","Document","attachShadow","mode","previous","previousId","rootId","targetDoc","parentSn","Text","childNodeArray","Array","isArray","childNodes","from","nodeType","TEXT_NODE","nextSibling","parentNode","contains","firstChild","targetId","legacy_resolveMissingNode","Date","now","resolveTrees","tree","debug","texts","textContent","attributeName","removeAttribute","newSn","newNode","ownerDocument","siblingNode","replace","styleValues","targetEl","s","removeProperty","svp","setProperty","svs","top","left","behavior","defaultView","checked","isChecked","text","selectionSet","ranges","startOffset","end","endOffset","startContainer","endContainer","result","Range","setStart","setEnd","selection","getSelection","range","removeAllRanges","addRange","getStyle","_d","nestedIndex","nestedRule","cssRules","deleteRule","call","replaceSync","priority","targetHost","styles","newStyleSheet","hostWindow","CSSStyleSheet","MAX_RETRY_TIME","count","adoptStyleSheets","styleIds","stylesToAdopt","targetMutation","previousInMap","nextInMap","base","_x","absoluteScale","_y","drawMouseTail","hoverElements","position","draw","clearRect","beginPath","moveTo","lineTo","stroke","hoveredEl","currentEl","parentElement","SkipEnd","log"],"sources":["/Users/ogonen/rrweb/node_modules/rrweb/es/rrweb/packages/rrweb/src/replay/index.js"],"sourcesContent":["import { __awaiter } from './../../../../ext/tslib/tslib.es6.js';\nimport { createCache, createMirror, rebuild, buildNodeWithSN, NodeType } from '../../../rrweb-snapshot/es/rrweb-snapshot.js';\nimport { RRDocument, diff, createOrGetNode, getDefaultSN, buildFromDom, buildFromNode } from '../../../rrdom/es/rrdom.js';\nimport * as mitt$1 from './../../../../ext/mitt/dist/mitt.mjs.js';\nimport mitt$2 from './../../../../ext/mitt/dist/mitt.mjs.js';\nimport { polyfill } from './smoothscroll.js';\nimport { Timer } from './timer.js';\nimport { createPlayerService, createSpeedService } from './machine.js';\nimport { EventType, ReplayerEvents, IncrementalSource, MouseInteractions } from '../../../types/dist/types.js';\nimport { StyleSheetMirror, polyfill as polyfill$1, isSerializedIframe, hasShadowRoot, queueToResolveTrees, iterateResolveTree, uniqueTextMutations, getPositionsAndIndex, getNestedRule, getBaseDimension } from '../utils.js';\nimport rules from './styles/inject-style.js';\nimport canvasMutation from './canvas/index.js';\nimport { deserializeArg } from './canvas/deserialize-args.js';\n\nconst SKIP_TIME_THRESHOLD = 10 * 1000;\r\nconst SKIP_TIME_INTERVAL = 5 * 1000;\r\nconst mitt = mitt$2 || mitt$1;\r\nconst REPLAY_CONSOLE_PREFIX = '[replayer]';\r\nconst defaultMouseTailConfig = {\r\n    duration: 500,\r\n    lineCap: 'round',\r\n    lineWidth: 3,\r\n    strokeStyle: 'red',\r\n};\r\nfunction indicatesTouchDevice(e) {\r\n    return (e.type == EventType.IncrementalSnapshot &&\r\n        (e.data.source == IncrementalSource.TouchMove ||\r\n            (e.data.source == IncrementalSource.MouseInteraction &&\r\n                e.data.type == MouseInteractions.TouchStart)));\r\n}\r\nclass Replayer {\r\n    constructor(events, config) {\r\n        this.usingVirtualDom = false;\r\n        this.virtualDom = new RRDocument();\r\n        this.mouseTail = null;\r\n        this.tailPositions = [];\r\n        this.emitter = mitt();\r\n        this.legacy_missingNodeRetryMap = {};\r\n        this.cache = createCache();\r\n        this.imageMap = new Map();\r\n        this.canvasEventMap = new Map();\r\n        this.mirror = createMirror();\r\n        this.styleMirror = new StyleSheetMirror();\r\n        this.firstFullSnapshot = null;\r\n        this.newDocumentQueue = [];\r\n        this.mousePos = null;\r\n        this.touchActive = null;\r\n        this.lastSelectionData = null;\r\n        this.constructedStyleMutations = [];\r\n        this.adoptedStyleSheets = [];\r\n        this.handleResize = (dimension) => {\r\n            this.iframe.style.display = 'inherit';\r\n            for (const el of [this.mouseTail, this.iframe]) {\r\n                if (!el) {\r\n                    continue;\r\n                }\r\n                el.setAttribute('width', String(dimension.width));\r\n                el.setAttribute('height', String(dimension.height));\r\n            }\r\n        };\r\n        this.applyEventsSynchronously = (events) => {\r\n            for (const event of events) {\r\n                switch (event.type) {\r\n                    case EventType.DomContentLoaded:\r\n                    case EventType.Load:\r\n                    case EventType.Custom:\r\n                        continue;\r\n                    case EventType.FullSnapshot:\r\n                    case EventType.Meta:\r\n                    case EventType.Plugin:\r\n                    case EventType.IncrementalSnapshot:\r\n                        break;\r\n                }\r\n                const castFn = this.getCastFn(event, true);\r\n                castFn();\r\n            }\r\n            if (this.touchActive === true) {\r\n                this.mouse.classList.add('touch-active');\r\n            }\r\n            else if (this.touchActive === false) {\r\n                this.mouse.classList.remove('touch-active');\r\n            }\r\n            this.touchActive = null;\r\n        };\r\n        this.getCastFn = (event, isSync = false) => {\r\n            let castFn;\r\n            switch (event.type) {\r\n                case EventType.DomContentLoaded:\r\n                case EventType.Load:\r\n                    break;\r\n                case EventType.Custom:\r\n                    castFn = () => {\r\n                        this.emitter.emit(ReplayerEvents.CustomEvent, event);\r\n                    };\r\n                    break;\r\n                case EventType.Meta:\r\n                    castFn = () => this.emitter.emit(ReplayerEvents.Resize, {\r\n                        width: event.data.width,\r\n                        height: event.data.height,\r\n                    });\r\n                    break;\r\n                case EventType.FullSnapshot:\r\n                    castFn = () => {\r\n                        var _a;\r\n                        if (this.firstFullSnapshot) {\r\n                            if (this.firstFullSnapshot === event) {\r\n                                this.firstFullSnapshot = true;\r\n                                return;\r\n                            }\r\n                        }\r\n                        else {\r\n                            this.firstFullSnapshot = true;\r\n                        }\r\n                        this.rebuildFullSnapshot(event, isSync);\r\n                        (_a = this.iframe.contentWindow) === null || _a === void 0 ? void 0 : _a.scrollTo(event.data.initialOffset);\r\n                        this.styleMirror.reset();\r\n                    };\r\n                    break;\r\n                case EventType.IncrementalSnapshot:\r\n                    castFn = () => {\r\n                        this.applyIncremental(event, isSync);\r\n                        if (isSync) {\r\n                            return;\r\n                        }\r\n                        if (event === this.nextUserInteractionEvent) {\r\n                            this.nextUserInteractionEvent = null;\r\n                            this.backToNormal();\r\n                        }\r\n                        if (this.config.skipInactive && !this.nextUserInteractionEvent) {\r\n                            for (const _event of this.service.state.context.events) {\r\n                                if (_event.timestamp <= event.timestamp) {\r\n                                    continue;\r\n                                }\r\n                                if (this.isUserInteraction(_event)) {\r\n                                    if (_event.delay - event.delay >\r\n                                        SKIP_TIME_THRESHOLD *\r\n                                            this.speedService.state.context.timer.speed) {\r\n                                        this.nextUserInteractionEvent = _event;\r\n                                    }\r\n                                    break;\r\n                                }\r\n                            }\r\n                            if (this.nextUserInteractionEvent) {\r\n                                const skipTime = this.nextUserInteractionEvent.delay - event.delay;\r\n                                const payload = {\r\n                                    speed: Math.min(Math.round(skipTime / SKIP_TIME_INTERVAL), this.config.maxSpeed),\r\n                                };\r\n                                this.speedService.send({ type: 'FAST_FORWARD', payload });\r\n                                this.emitter.emit(ReplayerEvents.SkipStart, payload);\r\n                            }\r\n                        }\r\n                    };\r\n                    break;\r\n            }\r\n            const wrappedCastFn = () => {\r\n                if (castFn) {\r\n                    castFn();\r\n                }\r\n                for (const plugin of this.config.plugins || []) {\r\n                    if (plugin.handler)\r\n                        plugin.handler(event, isSync, { replayer: this });\r\n                }\r\n                this.service.send({ type: 'CAST_EVENT', payload: { event } });\r\n                const last_index = this.service.state.context.events.length - 1;\r\n                if (event === this.service.state.context.events[last_index]) {\r\n                    const finish = () => {\r\n                        if (last_index < this.service.state.context.events.length - 1) {\r\n                            return;\r\n                        }\r\n                        this.backToNormal();\r\n                        this.service.send('END');\r\n                        this.emitter.emit(ReplayerEvents.Finish);\r\n                    };\r\n                    if (event.type === EventType.IncrementalSnapshot &&\r\n                        event.data.source === IncrementalSource.MouseMove &&\r\n                        event.data.positions.length) {\r\n                        setTimeout(() => {\r\n                            finish();\r\n                        }, Math.max(0, -event.data.positions[0].timeOffset + 50));\r\n                    }\r\n                    else {\r\n                        finish();\r\n                    }\r\n                }\r\n                this.emitter.emit(ReplayerEvents.EventCast, event);\r\n            };\r\n            return wrappedCastFn;\r\n        };\r\n        if (!(config === null || config === void 0 ? void 0 : config.liveMode) && events.length < 2) {\r\n            throw new Error('Replayer need at least 2 events.');\r\n        }\r\n        const defaultConfig = {\r\n            speed: 1,\r\n            maxSpeed: 360,\r\n            root: document.body,\r\n            loadTimeout: 0,\r\n            skipInactive: false,\r\n            showWarning: true,\r\n            showDebug: false,\r\n            blockClass: 'rr-block',\r\n            liveMode: false,\r\n            insertStyleRules: [],\r\n            triggerFocus: true,\r\n            UNSAFE_replayCanvas: false,\r\n            pauseAnimation: true,\r\n            mouseTail: defaultMouseTailConfig,\r\n            useVirtualDom: true,\r\n        };\r\n        this.config = Object.assign({}, defaultConfig, config);\r\n        this.handleResize = this.handleResize.bind(this);\r\n        this.getCastFn = this.getCastFn.bind(this);\r\n        this.applyEventsSynchronously = this.applyEventsSynchronously.bind(this);\r\n        this.emitter.on(ReplayerEvents.Resize, this.handleResize);\r\n        this.setupDom();\r\n        for (const plugin of this.config.plugins || []) {\r\n            if (plugin.getMirror)\r\n                plugin.getMirror({ nodeMirror: this.mirror });\r\n        }\r\n        this.emitter.on(ReplayerEvents.Flush, () => {\r\n            if (this.usingVirtualDom) {\r\n                const replayerHandler = {\r\n                    mirror: this.mirror,\r\n                    applyCanvas: (canvasEvent, canvasMutationData, target) => {\r\n                        void canvasMutation({\r\n                            event: canvasEvent,\r\n                            mutation: canvasMutationData,\r\n                            target,\r\n                            imageMap: this.imageMap,\r\n                            canvasEventMap: this.canvasEventMap,\r\n                            errorHandler: this.warnCanvasMutationFailed.bind(this),\r\n                        });\r\n                    },\r\n                    applyInput: this.applyInput.bind(this),\r\n                    applyScroll: this.applyScroll.bind(this),\r\n                    applyStyleSheetMutation: (data, styleSheet) => {\r\n                        if (data.source === IncrementalSource.StyleSheetRule)\r\n                            this.applyStyleSheetRule(data, styleSheet);\r\n                        else if (data.source === IncrementalSource.StyleDeclaration)\r\n                            this.applyStyleDeclaration(data, styleSheet);\r\n                    },\r\n                };\r\n                this.iframe.contentDocument &&\r\n                    diff(this.iframe.contentDocument, this.virtualDom, replayerHandler, this.virtualDom.mirror);\r\n                this.virtualDom.destroyTree();\r\n                this.usingVirtualDom = false;\r\n                if (Object.keys(this.legacy_missingNodeRetryMap).length) {\r\n                    for (const key in this.legacy_missingNodeRetryMap) {\r\n                        try {\r\n                            const value = this.legacy_missingNodeRetryMap[key];\r\n                            const realNode = createOrGetNode(value.node, this.mirror, this.virtualDom.mirror);\r\n                            diff(realNode, value.node, replayerHandler, this.virtualDom.mirror);\r\n                            value.node = realNode;\r\n                        }\r\n                        catch (error) {\r\n                            if (this.config.showWarning) {\r\n                                console.warn(error);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                this.constructedStyleMutations.forEach((data) => {\r\n                    this.applyStyleSheetMutation(data);\r\n                });\r\n                this.constructedStyleMutations = [];\r\n                this.adoptedStyleSheets.forEach((data) => {\r\n                    this.applyAdoptedStyleSheet(data);\r\n                });\r\n                this.adoptedStyleSheets = [];\r\n            }\r\n            if (this.mousePos) {\r\n                this.moveAndHover(this.mousePos.x, this.mousePos.y, this.mousePos.id, true, this.mousePos.debugData);\r\n                this.mousePos = null;\r\n            }\r\n            if (this.lastSelectionData) {\r\n                this.applySelection(this.lastSelectionData);\r\n                this.lastSelectionData = null;\r\n            }\r\n        });\r\n        this.emitter.on(ReplayerEvents.PlayBack, () => {\r\n            this.firstFullSnapshot = null;\r\n            this.mirror.reset();\r\n            this.styleMirror.reset();\r\n        });\r\n        const timer = new Timer([], {\r\n            speed: this.config.speed,\r\n            liveMode: this.config.liveMode,\r\n        });\r\n        this.service = createPlayerService({\r\n            events: events\r\n                .map((e) => {\r\n                if (config && config.unpackFn) {\r\n                    return config.unpackFn(e);\r\n                }\r\n                return e;\r\n            })\r\n                .sort((a1, a2) => a1.timestamp - a2.timestamp),\r\n            timer,\r\n            timeOffset: 0,\r\n            baselineTime: 0,\r\n            lastPlayedEvent: null,\r\n        }, {\r\n            getCastFn: this.getCastFn,\r\n            applyEventsSynchronously: this.applyEventsSynchronously,\r\n            emitter: this.emitter,\r\n        });\r\n        this.service.start();\r\n        this.service.subscribe((state) => {\r\n            this.emitter.emit(ReplayerEvents.StateChange, {\r\n                player: state,\r\n            });\r\n        });\r\n        this.speedService = createSpeedService({\r\n            normalSpeed: -1,\r\n            timer,\r\n        });\r\n        this.speedService.start();\r\n        this.speedService.subscribe((state) => {\r\n            this.emitter.emit(ReplayerEvents.StateChange, {\r\n                speed: state,\r\n            });\r\n        });\r\n        const firstMeta = this.service.state.context.events.find((e) => e.type === EventType.Meta);\r\n        const firstFullsnapshot = this.service.state.context.events.find((e) => e.type === EventType.FullSnapshot);\r\n        if (firstMeta) {\r\n            const { width, height } = firstMeta.data;\r\n            setTimeout(() => {\r\n                this.emitter.emit(ReplayerEvents.Resize, {\r\n                    width,\r\n                    height,\r\n                });\r\n            }, 0);\r\n        }\r\n        if (firstFullsnapshot) {\r\n            setTimeout(() => {\r\n                var _a;\r\n                if (this.firstFullSnapshot) {\r\n                    return;\r\n                }\r\n                this.firstFullSnapshot = firstFullsnapshot;\r\n                this.rebuildFullSnapshot(firstFullsnapshot);\r\n                (_a = this.iframe.contentWindow) === null || _a === void 0 ? void 0 : _a.scrollTo(firstFullsnapshot.data.initialOffset);\r\n            }, 1);\r\n        }\r\n        if (this.service.state.context.events.find(indicatesTouchDevice)) {\r\n            this.mouse.classList.add('touch-device');\r\n        }\r\n    }\r\n    get timer() {\r\n        return this.service.state.context.timer;\r\n    }\r\n    on(event, handler) {\r\n        this.emitter.on(event, handler);\r\n        return this;\r\n    }\r\n    off(event, handler) {\r\n        this.emitter.off(event, handler);\r\n        return this;\r\n    }\r\n    setConfig(config) {\r\n        Object.keys(config).forEach((key) => {\r\n            config[key];\r\n            this.config[key] = config[key];\r\n        });\r\n        if (!this.config.skipInactive) {\r\n            this.backToNormal();\r\n        }\r\n        if (typeof config.speed !== 'undefined') {\r\n            this.speedService.send({\r\n                type: 'SET_SPEED',\r\n                payload: {\r\n                    speed: config.speed,\r\n                },\r\n            });\r\n        }\r\n        if (typeof config.mouseTail !== 'undefined') {\r\n            if (config.mouseTail === false) {\r\n                if (this.mouseTail) {\r\n                    this.mouseTail.style.display = 'none';\r\n                }\r\n            }\r\n            else {\r\n                if (!this.mouseTail) {\r\n                    this.mouseTail = document.createElement('canvas');\r\n                    this.mouseTail.width = Number.parseFloat(this.iframe.width);\r\n                    this.mouseTail.height = Number.parseFloat(this.iframe.height);\r\n                    this.mouseTail.classList.add('replayer-mouse-tail');\r\n                    this.wrapper.insertBefore(this.mouseTail, this.iframe);\r\n                }\r\n                this.mouseTail.style.display = 'inherit';\r\n            }\r\n        }\r\n    }\r\n    getMetaData() {\r\n        const firstEvent = this.service.state.context.events[0];\r\n        const lastEvent = this.service.state.context.events[this.service.state.context.events.length - 1];\r\n        return {\r\n            startTime: firstEvent.timestamp,\r\n            endTime: lastEvent.timestamp,\r\n            totalTime: lastEvent.timestamp - firstEvent.timestamp,\r\n        };\r\n    }\r\n    getCurrentTime() {\r\n        return this.timer.timeOffset + this.getTimeOffset();\r\n    }\r\n    getTimeOffset() {\r\n        const { baselineTime, events } = this.service.state.context;\r\n        return baselineTime - events[0].timestamp;\r\n    }\r\n    getMirror() {\r\n        return this.mirror;\r\n    }\r\n    play(timeOffset = 0) {\r\n        var _a, _b;\r\n        if (this.service.state.matches('paused')) {\r\n            this.service.send({ type: 'PLAY', payload: { timeOffset } });\r\n        }\r\n        else {\r\n            this.service.send({ type: 'PAUSE' });\r\n            this.service.send({ type: 'PLAY', payload: { timeOffset } });\r\n        }\r\n        (_b = (_a = this.iframe.contentDocument) === null || _a === void 0 ? void 0 : _a.getElementsByTagName('html')[0]) === null || _b === void 0 ? void 0 : _b.classList.remove('rrweb-paused');\r\n        this.emitter.emit(ReplayerEvents.Start);\r\n    }\r\n    pause(timeOffset) {\r\n        var _a, _b;\r\n        if (timeOffset === undefined && this.service.state.matches('playing')) {\r\n            this.service.send({ type: 'PAUSE' });\r\n        }\r\n        if (typeof timeOffset === 'number') {\r\n            this.play(timeOffset);\r\n            this.service.send({ type: 'PAUSE' });\r\n        }\r\n        (_b = (_a = this.iframe.contentDocument) === null || _a === void 0 ? void 0 : _a.getElementsByTagName('html')[0]) === null || _b === void 0 ? void 0 : _b.classList.add('rrweb-paused');\r\n        this.emitter.emit(ReplayerEvents.Pause);\r\n    }\r\n    resume(timeOffset = 0) {\r\n        console.warn(`The 'resume' was deprecated in 1.0. Please use 'play' method which has the same interface.`);\r\n        this.play(timeOffset);\r\n        this.emitter.emit(ReplayerEvents.Resume);\r\n    }\r\n    destroy() {\r\n        this.pause();\r\n        this.config.root.removeChild(this.wrapper);\r\n        this.emitter.emit(ReplayerEvents.Destroy);\r\n    }\r\n    startLive(baselineTime) {\r\n        this.service.send({ type: 'TO_LIVE', payload: { baselineTime } });\r\n    }\r\n    addEvent(rawEvent) {\r\n        const event = this.config.unpackFn\r\n            ? this.config.unpackFn(rawEvent)\r\n            : rawEvent;\r\n        if (indicatesTouchDevice(event)) {\r\n            this.mouse.classList.add('touch-device');\r\n        }\r\n        void Promise.resolve().then(() => this.service.send({ type: 'ADD_EVENT', payload: { event } }));\r\n    }\r\n    enableInteract() {\r\n        this.iframe.setAttribute('scrolling', 'auto');\r\n        this.iframe.style.pointerEvents = 'auto';\r\n    }\r\n    disableInteract() {\r\n        this.iframe.setAttribute('scrolling', 'no');\r\n        this.iframe.style.pointerEvents = 'none';\r\n    }\r\n    resetCache() {\r\n        this.cache = createCache();\r\n    }\r\n    setupDom() {\r\n        this.wrapper = document.createElement('div');\r\n        this.wrapper.classList.add('replayer-wrapper');\r\n        this.config.root.appendChild(this.wrapper);\r\n        this.mouse = document.createElement('div');\r\n        this.mouse.classList.add('replayer-mouse');\r\n        this.wrapper.appendChild(this.mouse);\r\n        if (this.config.mouseTail !== false) {\r\n            this.mouseTail = document.createElement('canvas');\r\n            this.mouseTail.classList.add('replayer-mouse-tail');\r\n            this.mouseTail.style.display = 'inherit';\r\n            this.wrapper.appendChild(this.mouseTail);\r\n        }\r\n        this.iframe = document.createElement('iframe');\r\n        const attributes = ['allow-same-origin'];\r\n        if (this.config.UNSAFE_replayCanvas) {\r\n            attributes.push('allow-scripts');\r\n        }\r\n        this.iframe.style.display = 'none';\r\n        this.iframe.setAttribute('sandbox', attributes.join(' '));\r\n        this.disableInteract();\r\n        this.wrapper.appendChild(this.iframe);\r\n        if (this.iframe.contentWindow && this.iframe.contentDocument) {\r\n            polyfill(this.iframe.contentWindow, this.iframe.contentDocument);\r\n            polyfill$1(this.iframe.contentWindow);\r\n        }\r\n    }\r\n    rebuildFullSnapshot(event, isSync = false) {\r\n        if (!this.iframe.contentDocument) {\r\n            return console.warn('Looks like your replayer has been destroyed.');\r\n        }\r\n        if (Object.keys(this.legacy_missingNodeRetryMap).length) {\r\n            console.warn('Found unresolved missing node map', this.legacy_missingNodeRetryMap);\r\n        }\r\n        this.legacy_missingNodeRetryMap = {};\r\n        const collected = [];\r\n        const afterAppend = (builtNode, id) => {\r\n            this.collectIframeAndAttachDocument(collected, builtNode);\r\n            for (const plugin of this.config.plugins || []) {\r\n                if (plugin.onBuild)\r\n                    plugin.onBuild(builtNode, {\r\n                        id,\r\n                        replayer: this,\r\n                    });\r\n            }\r\n        };\r\n        rebuild(event.data.node, {\r\n            doc: this.iframe.contentDocument,\r\n            afterAppend,\r\n            cache: this.cache,\r\n            mirror: this.mirror,\r\n        });\r\n        afterAppend(this.iframe.contentDocument, event.data.node.id);\r\n        for (const { mutationInQueue, builtNode } of collected) {\r\n            this.attachDocumentToIframe(mutationInQueue, builtNode);\r\n            this.newDocumentQueue = this.newDocumentQueue.filter((m) => m !== mutationInQueue);\r\n        }\r\n        const { documentElement, head } = this.iframe.contentDocument;\r\n        this.insertStyleRules(documentElement, head);\r\n        if (!this.service.state.matches('playing')) {\r\n            this.iframe.contentDocument\r\n                .getElementsByTagName('html')[0]\r\n                .classList.add('rrweb-paused');\r\n        }\r\n        this.emitter.emit(ReplayerEvents.FullsnapshotRebuilded, event);\r\n        if (!isSync) {\r\n            this.waitForStylesheetLoad();\r\n        }\r\n        if (this.config.UNSAFE_replayCanvas) {\r\n            void this.preloadAllImages();\r\n        }\r\n    }\r\n    insertStyleRules(documentElement, head) {\r\n        var _a;\r\n        const injectStylesRules = rules(this.config.blockClass).concat(this.config.insertStyleRules);\r\n        if (this.config.pauseAnimation) {\r\n            injectStylesRules.push('html.rrweb-paused *, html.rrweb-paused *:before, html.rrweb-paused *:after { animation-play-state: paused !important; }');\r\n        }\r\n        if (this.usingVirtualDom) {\r\n            const styleEl = this.virtualDom.createElement('style');\r\n            this.virtualDom.mirror.add(styleEl, getDefaultSN(styleEl, this.virtualDom.unserializedId));\r\n            documentElement.insertBefore(styleEl, head);\r\n            styleEl.rules.push({\r\n                source: IncrementalSource.StyleSheetRule,\r\n                adds: injectStylesRules.map((cssText, index) => ({\r\n                    rule: cssText,\r\n                    index,\r\n                })),\r\n            });\r\n        }\r\n        else {\r\n            const styleEl = document.createElement('style');\r\n            documentElement.insertBefore(styleEl, head);\r\n            for (let idx = 0; idx < injectStylesRules.length; idx++) {\r\n                (_a = styleEl.sheet) === null || _a === void 0 ? void 0 : _a.insertRule(injectStylesRules[idx], idx);\r\n            }\r\n        }\r\n    }\r\n    attachDocumentToIframe(mutation, iframeEl) {\r\n        const mirror = this.usingVirtualDom\r\n            ? this.virtualDom.mirror\r\n            : this.mirror;\r\n        const collected = [];\r\n        const afterAppend = (builtNode, id) => {\r\n            this.collectIframeAndAttachDocument(collected, builtNode);\r\n            const sn = mirror.getMeta(builtNode);\r\n            if ((sn === null || sn === void 0 ? void 0 : sn.type) === NodeType.Element &&\r\n                (sn === null || sn === void 0 ? void 0 : sn.tagName.toUpperCase()) === 'HTML') {\r\n                const { documentElement, head } = iframeEl.contentDocument;\r\n                this.insertStyleRules(documentElement, head);\r\n            }\r\n            for (const plugin of this.config.plugins || []) {\r\n                if (plugin.onBuild)\r\n                    plugin.onBuild(builtNode, {\r\n                        id,\r\n                        replayer: this,\r\n                    });\r\n            }\r\n        };\r\n        buildNodeWithSN(mutation.node, {\r\n            doc: iframeEl.contentDocument,\r\n            mirror: mirror,\r\n            hackCss: true,\r\n            skipChild: false,\r\n            afterAppend,\r\n            cache: this.cache,\r\n        });\r\n        afterAppend(iframeEl.contentDocument, mutation.node.id);\r\n        for (const { mutationInQueue, builtNode } of collected) {\r\n            this.attachDocumentToIframe(mutationInQueue, builtNode);\r\n            this.newDocumentQueue = this.newDocumentQueue.filter((m) => m !== mutationInQueue);\r\n        }\r\n    }\r\n    collectIframeAndAttachDocument(collected, builtNode) {\r\n        if (isSerializedIframe(builtNode, this.mirror)) {\r\n            const mutationInQueue = this.newDocumentQueue.find((m) => m.parentId === this.mirror.getId(builtNode));\r\n            if (mutationInQueue) {\r\n                collected.push({\r\n                    mutationInQueue,\r\n                    builtNode: builtNode,\r\n                });\r\n            }\r\n        }\r\n    }\r\n    waitForStylesheetLoad() {\r\n        var _a;\r\n        const head = (_a = this.iframe.contentDocument) === null || _a === void 0 ? void 0 : _a.head;\r\n        if (head) {\r\n            const unloadSheets = new Set();\r\n            let timer;\r\n            let beforeLoadState = this.service.state;\r\n            const stateHandler = () => {\r\n                beforeLoadState = this.service.state;\r\n            };\r\n            this.emitter.on(ReplayerEvents.Start, stateHandler);\r\n            this.emitter.on(ReplayerEvents.Pause, stateHandler);\r\n            const unsubscribe = () => {\r\n                this.emitter.off(ReplayerEvents.Start, stateHandler);\r\n                this.emitter.off(ReplayerEvents.Pause, stateHandler);\r\n            };\r\n            head\r\n                .querySelectorAll('link[rel=\"stylesheet\"]')\r\n                .forEach((css) => {\r\n                if (!css.sheet) {\r\n                    unloadSheets.add(css);\r\n                    css.addEventListener('load', () => {\r\n                        unloadSheets.delete(css);\r\n                        if (unloadSheets.size === 0 && timer !== -1) {\r\n                            if (beforeLoadState.matches('playing')) {\r\n                                this.play(this.getCurrentTime());\r\n                            }\r\n                            this.emitter.emit(ReplayerEvents.LoadStylesheetEnd);\r\n                            if (timer) {\r\n                                clearTimeout(timer);\r\n                            }\r\n                            unsubscribe();\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n            if (unloadSheets.size > 0) {\r\n                this.service.send({ type: 'PAUSE' });\r\n                this.emitter.emit(ReplayerEvents.LoadStylesheetStart);\r\n                timer = setTimeout(() => {\r\n                    if (beforeLoadState.matches('playing')) {\r\n                        this.play(this.getCurrentTime());\r\n                    }\r\n                    timer = -1;\r\n                    unsubscribe();\r\n                }, this.config.loadTimeout);\r\n            }\r\n        }\r\n    }\r\n    preloadAllImages() {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            this.service.state;\r\n            const stateHandler = () => {\r\n                this.service.state;\r\n            };\r\n            this.emitter.on(ReplayerEvents.Start, stateHandler);\r\n            this.emitter.on(ReplayerEvents.Pause, stateHandler);\r\n            const promises = [];\r\n            for (const event of this.service.state.context.events) {\r\n                if (event.type === EventType.IncrementalSnapshot &&\r\n                    event.data.source === IncrementalSource.CanvasMutation) {\r\n                    promises.push(this.deserializeAndPreloadCanvasEvents(event.data, event));\r\n                    const commands = 'commands' in event.data ? event.data.commands : [event.data];\r\n                    commands.forEach((c) => {\r\n                        this.preloadImages(c, event);\r\n                    });\r\n                }\r\n            }\r\n            return Promise.all(promises);\r\n        });\r\n    }\r\n    preloadImages(data, event) {\r\n        if (data.property === 'drawImage' &&\r\n            typeof data.args[0] === 'string' &&\r\n            !this.imageMap.has(event)) {\r\n            const canvas = document.createElement('canvas');\r\n            const ctx = canvas.getContext('2d');\r\n            const imgd = ctx === null || ctx === void 0 ? void 0 : ctx.createImageData(canvas.width, canvas.height);\r\n            imgd === null || imgd === void 0 ? void 0 : imgd.data;\r\n            JSON.parse(data.args[0]);\r\n            ctx === null || ctx === void 0 ? void 0 : ctx.putImageData(imgd, 0, 0);\r\n        }\r\n    }\r\n    deserializeAndPreloadCanvasEvents(data, event) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (!this.canvasEventMap.has(event)) {\r\n                const status = {\r\n                    isUnchanged: true,\r\n                };\r\n                if ('commands' in data) {\r\n                    const commands = yield Promise.all(data.commands.map((c) => __awaiter(this, void 0, void 0, function* () {\r\n                        const args = yield Promise.all(c.args.map(deserializeArg(this.imageMap, null, status)));\r\n                        return Object.assign(Object.assign({}, c), { args });\r\n                    })));\r\n                    if (status.isUnchanged === false)\r\n                        this.canvasEventMap.set(event, Object.assign(Object.assign({}, data), { commands }));\r\n                }\r\n                else {\r\n                    const args = yield Promise.all(data.args.map(deserializeArg(this.imageMap, null, status)));\r\n                    if (status.isUnchanged === false)\r\n                        this.canvasEventMap.set(event, Object.assign(Object.assign({}, data), { args }));\r\n                }\r\n            }\r\n        });\r\n    }\r\n    applyIncremental(e, isSync) {\r\n        var _a, _b, _c;\r\n        const { data: d } = e;\r\n        switch (d.source) {\r\n            case IncrementalSource.Mutation: {\r\n                try {\r\n                    this.applyMutation(d, isSync);\r\n                }\r\n                catch (error) {\r\n                    this.warn(`Exception in mutation ${error.message || error}`, d);\r\n                }\r\n                break;\r\n            }\r\n            case IncrementalSource.Drag:\r\n            case IncrementalSource.TouchMove:\r\n            case IncrementalSource.MouseMove:\r\n                if (isSync) {\r\n                    const lastPosition = d.positions[d.positions.length - 1];\r\n                    this.mousePos = {\r\n                        x: lastPosition.x,\r\n                        y: lastPosition.y,\r\n                        id: lastPosition.id,\r\n                        debugData: d,\r\n                    };\r\n                }\r\n                else {\r\n                    d.positions.forEach((p) => {\r\n                        const action = {\r\n                            doAction: () => {\r\n                                this.moveAndHover(p.x, p.y, p.id, isSync, d);\r\n                            },\r\n                            delay: p.timeOffset +\r\n                                e.timestamp -\r\n                                this.service.state.context.baselineTime,\r\n                        };\r\n                        this.timer.addAction(action);\r\n                    });\r\n                    this.timer.addAction({\r\n                        doAction() {\r\n                        },\r\n                        delay: e.delay - ((_a = d.positions[0]) === null || _a === void 0 ? void 0 : _a.timeOffset),\r\n                    });\r\n                }\r\n                break;\r\n            case IncrementalSource.MouseInteraction: {\r\n                if (d.id === -1 || isSync) {\r\n                    break;\r\n                }\r\n                const event = new Event(MouseInteractions[d.type].toLowerCase());\r\n                const target = this.mirror.getNode(d.id);\r\n                if (!target) {\r\n                    return this.debugNodeNotFound(d, d.id);\r\n                }\r\n                this.emitter.emit(ReplayerEvents.MouseInteraction, {\r\n                    type: d.type,\r\n                    target,\r\n                });\r\n                const { triggerFocus } = this.config;\r\n                switch (d.type) {\r\n                    case MouseInteractions.Blur:\r\n                        if ('blur' in target) {\r\n                            target.blur();\r\n                        }\r\n                        break;\r\n                    case MouseInteractions.Focus:\r\n                        if (triggerFocus && target.focus) {\r\n                            target.focus({\r\n                                preventScroll: true,\r\n                            });\r\n                        }\r\n                        break;\r\n                    case MouseInteractions.Click:\r\n                    case MouseInteractions.TouchStart:\r\n                    case MouseInteractions.TouchEnd:\r\n                        if (isSync) {\r\n                            if (d.type === MouseInteractions.TouchStart) {\r\n                                this.touchActive = true;\r\n                            }\r\n                            else if (d.type === MouseInteractions.TouchEnd) {\r\n                                this.touchActive = false;\r\n                            }\r\n                            this.mousePos = {\r\n                                x: d.x,\r\n                                y: d.y,\r\n                                id: d.id,\r\n                                debugData: d,\r\n                            };\r\n                        }\r\n                        else {\r\n                            if (d.type === MouseInteractions.TouchStart) {\r\n                                this.tailPositions.length = 0;\r\n                            }\r\n                            this.moveAndHover(d.x, d.y, d.id, isSync, d);\r\n                            if (d.type === MouseInteractions.Click) {\r\n                                this.mouse.classList.remove('active');\r\n                                void this.mouse.offsetWidth;\r\n                                this.mouse.classList.add('active');\r\n                            }\r\n                            else if (d.type === MouseInteractions.TouchStart) {\r\n                                void this.mouse.offsetWidth;\r\n                                this.mouse.classList.add('touch-active');\r\n                            }\r\n                            else if (d.type === MouseInteractions.TouchEnd) {\r\n                                this.mouse.classList.remove('touch-active');\r\n                            }\r\n                        }\r\n                        break;\r\n                    case MouseInteractions.TouchCancel:\r\n                        if (isSync) {\r\n                            this.touchActive = false;\r\n                        }\r\n                        else {\r\n                            this.mouse.classList.remove('touch-active');\r\n                        }\r\n                        break;\r\n                    default:\r\n                        target.dispatchEvent(event);\r\n                }\r\n                break;\r\n            }\r\n            case IncrementalSource.Scroll: {\r\n                if (d.id === -1) {\r\n                    break;\r\n                }\r\n                if (this.usingVirtualDom) {\r\n                    const target = this.virtualDom.mirror.getNode(d.id);\r\n                    if (!target) {\r\n                        return this.debugNodeNotFound(d, d.id);\r\n                    }\r\n                    target.scrollData = d;\r\n                    break;\r\n                }\r\n                this.applyScroll(d, isSync);\r\n                break;\r\n            }\r\n            case IncrementalSource.ViewportResize:\r\n                this.emitter.emit(ReplayerEvents.Resize, {\r\n                    width: d.width,\r\n                    height: d.height,\r\n                });\r\n                break;\r\n            case IncrementalSource.Input: {\r\n                if (d.id === -1) {\r\n                    break;\r\n                }\r\n                if (this.usingVirtualDom) {\r\n                    const target = this.virtualDom.mirror.getNode(d.id);\r\n                    if (!target) {\r\n                        return this.debugNodeNotFound(d, d.id);\r\n                    }\r\n                    target.inputData = d;\r\n                    break;\r\n                }\r\n                this.applyInput(d);\r\n                break;\r\n            }\r\n            case IncrementalSource.MediaInteraction: {\r\n                const target = this.usingVirtualDom\r\n                    ? this.virtualDom.mirror.getNode(d.id)\r\n                    : this.mirror.getNode(d.id);\r\n                if (!target) {\r\n                    return this.debugNodeNotFound(d, d.id);\r\n                }\r\n                const mediaEl = target;\r\n                try {\r\n                    if (d.currentTime) {\r\n                        mediaEl.currentTime = d.currentTime;\r\n                    }\r\n                    if (d.volume) {\r\n                        mediaEl.volume = d.volume;\r\n                    }\r\n                    if (d.muted) {\r\n                        mediaEl.muted = d.muted;\r\n                    }\r\n                    if (d.type === 1) {\r\n                        mediaEl.pause();\r\n                    }\r\n                    if (d.type === 0) {\r\n                        void mediaEl.play();\r\n                    }\r\n                    if (d.type === 4) {\r\n                        mediaEl.playbackRate = d.playbackRate;\r\n                    }\r\n                }\r\n                catch (error) {\r\n                    if (this.config.showWarning) {\r\n                        console.warn(`Failed to replay media interactions: ${error.message || error}`);\r\n                    }\r\n                }\r\n                break;\r\n            }\r\n            case IncrementalSource.StyleSheetRule:\r\n            case IncrementalSource.StyleDeclaration: {\r\n                if (this.usingVirtualDom) {\r\n                    if (d.styleId)\r\n                        this.constructedStyleMutations.push(d);\r\n                    else if (d.id)\r\n                        (_b = this.virtualDom.mirror.getNode(d.id)) === null || _b === void 0 ? void 0 : _b.rules.push(d);\r\n                }\r\n                else\r\n                    this.applyStyleSheetMutation(d);\r\n                break;\r\n            }\r\n            case IncrementalSource.CanvasMutation: {\r\n                if (!this.config.UNSAFE_replayCanvas) {\r\n                    return;\r\n                }\r\n                if (this.usingVirtualDom) {\r\n                    const target = this.virtualDom.mirror.getNode(d.id);\r\n                    if (!target) {\r\n                        return this.debugNodeNotFound(d, d.id);\r\n                    }\r\n                    target.canvasMutations.push({\r\n                        event: e,\r\n                        mutation: d,\r\n                    });\r\n                }\r\n                else {\r\n                    const target = this.mirror.getNode(d.id);\r\n                    if (!target) {\r\n                        return this.debugNodeNotFound(d, d.id);\r\n                    }\r\n                    void canvasMutation({\r\n                        event: e,\r\n                        mutation: d,\r\n                        target: target,\r\n                        imageMap: this.imageMap,\r\n                        canvasEventMap: this.canvasEventMap,\r\n                        errorHandler: this.warnCanvasMutationFailed.bind(this),\r\n                    });\r\n                }\r\n                break;\r\n            }\r\n            case IncrementalSource.Font: {\r\n                try {\r\n                    const fontFace = new FontFace(d.family, d.buffer\r\n                        ? new Uint8Array(JSON.parse(d.fontSource))\r\n                        : d.fontSource, d.descriptors);\r\n                    (_c = this.iframe.contentDocument) === null || _c === void 0 ? void 0 : _c.fonts.add(fontFace);\r\n                }\r\n                catch (error) {\r\n                    if (this.config.showWarning) {\r\n                        console.warn(error);\r\n                    }\r\n                }\r\n                break;\r\n            }\r\n            case IncrementalSource.Selection: {\r\n                if (isSync) {\r\n                    this.lastSelectionData = d;\r\n                    break;\r\n                }\r\n                this.applySelection(d);\r\n                break;\r\n            }\r\n            case IncrementalSource.AdoptedStyleSheet: {\r\n                if (this.usingVirtualDom)\r\n                    this.adoptedStyleSheets.push(d);\r\n                else\r\n                    this.applyAdoptedStyleSheet(d);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n    applyMutation(d, isSync) {\r\n        if (this.config.useVirtualDom && !this.usingVirtualDom && isSync) {\r\n            this.usingVirtualDom = true;\r\n            buildFromDom(this.iframe.contentDocument, this.mirror, this.virtualDom);\r\n            if (Object.keys(this.legacy_missingNodeRetryMap).length) {\r\n                for (const key in this.legacy_missingNodeRetryMap) {\r\n                    try {\r\n                        const value = this.legacy_missingNodeRetryMap[key];\r\n                        const virtualNode = buildFromNode(value.node, this.virtualDom, this.mirror);\r\n                        if (virtualNode)\r\n                            value.node = virtualNode;\r\n                    }\r\n                    catch (error) {\r\n                        if (this.config.showWarning) {\r\n                            console.warn(error);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        const mirror = this.usingVirtualDom ? this.virtualDom.mirror : this.mirror;\r\n        d.removes.forEach((mutation) => {\r\n            var _a;\r\n            const target = mirror.getNode(mutation.id);\r\n            if (!target) {\r\n                if (d.removes.find((r) => r.id === mutation.parentId)) {\r\n                    return;\r\n                }\r\n                return this.warnNodeNotFound(d, mutation.id);\r\n            }\r\n            let parent = mirror.getNode(mutation.parentId);\r\n            if (!parent) {\r\n                return this.warnNodeNotFound(d, mutation.parentId);\r\n            }\r\n            if (mutation.isShadow && hasShadowRoot(parent)) {\r\n                parent = parent.shadowRoot;\r\n            }\r\n            mirror.removeNodeFromMap(target);\r\n            if (parent)\r\n                try {\r\n                    parent.removeChild(target);\r\n                    if (this.usingVirtualDom &&\r\n                        target.nodeName === '#text' &&\r\n                        parent.nodeName === 'STYLE' &&\r\n                        ((_a = parent.rules) === null || _a === void 0 ? void 0 : _a.length) > 0)\r\n                        parent.rules = [];\r\n                }\r\n                catch (error) {\r\n                    if (error instanceof DOMException) {\r\n                        this.warn('parent could not remove child in mutation', parent, target, d);\r\n                    }\r\n                    else {\r\n                        throw error;\r\n                    }\r\n                }\r\n        });\r\n        const legacy_missingNodeMap = Object.assign({}, this.legacy_missingNodeRetryMap);\r\n        const queue = [];\r\n        const nextNotInDOM = (mutation) => {\r\n            let next = null;\r\n            if (mutation.nextId) {\r\n                next = mirror.getNode(mutation.nextId);\r\n            }\r\n            if (mutation.nextId !== null &&\r\n                mutation.nextId !== undefined &&\r\n                mutation.nextId !== -1 &&\r\n                !next) {\r\n                return true;\r\n            }\r\n            return false;\r\n        };\r\n        const appendNode = (mutation) => {\r\n            var _a;\r\n            if (!this.iframe.contentDocument) {\r\n                return console.warn('Looks like your replayer has been destroyed.');\r\n            }\r\n            let parent = mirror.getNode(mutation.parentId);\r\n            if (!parent) {\r\n                if (mutation.node.type === NodeType.Document) {\r\n                    return this.newDocumentQueue.push(mutation);\r\n                }\r\n                return queue.push(mutation);\r\n            }\r\n            if (mutation.node.isShadow) {\r\n                if (!hasShadowRoot(parent)) {\r\n                    parent.attachShadow({ mode: 'open' });\r\n                    parent = parent.shadowRoot;\r\n                }\r\n                else\r\n                    parent = parent.shadowRoot;\r\n            }\r\n            let previous = null;\r\n            let next = null;\r\n            if (mutation.previousId) {\r\n                previous = mirror.getNode(mutation.previousId);\r\n            }\r\n            if (mutation.nextId) {\r\n                next = mirror.getNode(mutation.nextId);\r\n            }\r\n            if (nextNotInDOM(mutation)) {\r\n                return queue.push(mutation);\r\n            }\r\n            if (mutation.node.rootId && !mirror.getNode(mutation.node.rootId)) {\r\n                return;\r\n            }\r\n            const targetDoc = mutation.node.rootId\r\n                ? mirror.getNode(mutation.node.rootId)\r\n                : this.usingVirtualDom\r\n                    ? this.virtualDom\r\n                    : this.iframe.contentDocument;\r\n            if (isSerializedIframe(parent, mirror)) {\r\n                this.attachDocumentToIframe(mutation, parent);\r\n                return;\r\n            }\r\n            const afterAppend = (node, id) => {\r\n                for (const plugin of this.config.plugins || []) {\r\n                    if (plugin.onBuild)\r\n                        plugin.onBuild(node, { id, replayer: this });\r\n                }\r\n            };\r\n            const target = buildNodeWithSN(mutation.node, {\r\n                doc: targetDoc,\r\n                mirror: mirror,\r\n                skipChild: true,\r\n                hackCss: true,\r\n                cache: this.cache,\r\n                afterAppend,\r\n            });\r\n            if (mutation.previousId === -1 || mutation.nextId === -1) {\r\n                legacy_missingNodeMap[mutation.node.id] = {\r\n                    node: target,\r\n                    mutation,\r\n                };\r\n                return;\r\n            }\r\n            const parentSn = mirror.getMeta(parent);\r\n            if (parentSn &&\r\n                parentSn.type === NodeType.Element &&\r\n                parentSn.tagName === 'textarea' &&\r\n                mutation.node.type === NodeType.Text) {\r\n                const childNodeArray = Array.isArray(parent.childNodes)\r\n                    ? parent.childNodes\r\n                    : Array.from(parent.childNodes);\r\n                for (const c of childNodeArray) {\r\n                    if (c.nodeType === parent.TEXT_NODE) {\r\n                        parent.removeChild(c);\r\n                    }\r\n                }\r\n            }\r\n            if (previous && previous.nextSibling && previous.nextSibling.parentNode) {\r\n                parent.insertBefore(target, previous.nextSibling);\r\n            }\r\n            else if (next && next.parentNode) {\r\n                parent.contains(next)\r\n                    ? parent.insertBefore(target, next)\r\n                    : parent.insertBefore(target, null);\r\n            }\r\n            else {\r\n                if (parent === targetDoc) {\r\n                    while (targetDoc.firstChild) {\r\n                        targetDoc.removeChild(targetDoc.firstChild);\r\n                    }\r\n                }\r\n                parent.appendChild(target);\r\n            }\r\n            afterAppend(target, mutation.node.id);\r\n            if (this.usingVirtualDom &&\r\n                target.nodeName === '#text' &&\r\n                parent.nodeName === 'STYLE' &&\r\n                ((_a = parent.rules) === null || _a === void 0 ? void 0 : _a.length) > 0)\r\n                parent.rules = [];\r\n            if (isSerializedIframe(target, this.mirror)) {\r\n                const targetId = this.mirror.getId(target);\r\n                const mutationInQueue = this.newDocumentQueue.find((m) => m.parentId === targetId);\r\n                if (mutationInQueue) {\r\n                    this.attachDocumentToIframe(mutationInQueue, target);\r\n                    this.newDocumentQueue = this.newDocumentQueue.filter((m) => m !== mutationInQueue);\r\n                }\r\n            }\r\n            if (mutation.previousId || mutation.nextId) {\r\n                this.legacy_resolveMissingNode(legacy_missingNodeMap, parent, target, mutation);\r\n            }\r\n        };\r\n        d.adds.forEach((mutation) => {\r\n            appendNode(mutation);\r\n        });\r\n        const startTime = Date.now();\r\n        while (queue.length) {\r\n            const resolveTrees = queueToResolveTrees(queue);\r\n            queue.length = 0;\r\n            if (Date.now() - startTime > 500) {\r\n                this.warn('Timeout in the loop, please check the resolve tree data:', resolveTrees);\r\n                break;\r\n            }\r\n            for (const tree of resolveTrees) {\r\n                const parent = mirror.getNode(tree.value.parentId);\r\n                if (!parent) {\r\n                    this.debug('Drop resolve tree since there is no parent for the root node.', tree);\r\n                }\r\n                else {\r\n                    iterateResolveTree(tree, (mutation) => {\r\n                        appendNode(mutation);\r\n                    });\r\n                }\r\n            }\r\n        }\r\n        if (Object.keys(legacy_missingNodeMap).length) {\r\n            Object.assign(this.legacy_missingNodeRetryMap, legacy_missingNodeMap);\r\n        }\r\n        uniqueTextMutations(d.texts).forEach((mutation) => {\r\n            var _a;\r\n            const target = mirror.getNode(mutation.id);\r\n            if (!target) {\r\n                if (d.removes.find((r) => r.id === mutation.id)) {\r\n                    return;\r\n                }\r\n                return this.warnNodeNotFound(d, mutation.id);\r\n            }\r\n            target.textContent = mutation.value;\r\n            if (this.usingVirtualDom) {\r\n                const parent = target.parentNode;\r\n                if (((_a = parent === null || parent === void 0 ? void 0 : parent.rules) === null || _a === void 0 ? void 0 : _a.length) > 0)\r\n                    parent.rules = [];\r\n            }\r\n        });\r\n        d.attributes.forEach((mutation) => {\r\n            const target = mirror.getNode(mutation.id);\r\n            if (!target) {\r\n                if (d.removes.find((r) => r.id === mutation.id)) {\r\n                    return;\r\n                }\r\n                return this.warnNodeNotFound(d, mutation.id);\r\n            }\r\n            for (const attributeName in mutation.attributes) {\r\n                if (typeof attributeName === 'string') {\r\n                    const value = mutation.attributes[attributeName];\r\n                    if (value === null) {\r\n                        target.removeAttribute(attributeName);\r\n                    }\r\n                    else if (typeof value === 'string') {\r\n                        try {\r\n                            if (attributeName === '_cssText' &&\r\n                                (target.nodeName === 'LINK' || target.nodeName === 'STYLE')) {\r\n                                try {\r\n                                    const newSn = mirror.getMeta(target);\r\n                                    Object.assign(newSn.attributes, mutation.attributes);\r\n                                    const newNode = buildNodeWithSN(newSn, {\r\n                                        doc: target.ownerDocument,\r\n                                        mirror: mirror,\r\n                                        skipChild: true,\r\n                                        hackCss: true,\r\n                                        cache: this.cache,\r\n                                    });\r\n                                    const siblingNode = target.nextSibling;\r\n                                    const parentNode = target.parentNode;\r\n                                    if (newNode && parentNode) {\r\n                                        parentNode.removeChild(target);\r\n                                        parentNode.insertBefore(newNode, siblingNode);\r\n                                        mirror.replace(mutation.id, newNode);\r\n                                        break;\r\n                                    }\r\n                                }\r\n                                catch (e) {\r\n                                }\r\n                            }\r\n                            target.setAttribute(attributeName, value);\r\n                        }\r\n                        catch (error) {\r\n                            if (this.config.showWarning) {\r\n                                console.warn('An error occurred may due to the checkout feature.', error);\r\n                            }\r\n                        }\r\n                    }\r\n                    else if (attributeName === 'style') {\r\n                        const styleValues = value;\r\n                        const targetEl = target;\r\n                        for (const s in styleValues) {\r\n                            if (styleValues[s] === false) {\r\n                                targetEl.style.removeProperty(s);\r\n                            }\r\n                            else if (styleValues[s] instanceof Array) {\r\n                                const svp = styleValues[s];\r\n                                targetEl.style.setProperty(s, svp[0], svp[1]);\r\n                            }\r\n                            else {\r\n                                const svs = styleValues[s];\r\n                                targetEl.style.setProperty(s, svs);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n    applyScroll(d, isSync) {\r\n        var _a, _b;\r\n        const target = this.mirror.getNode(d.id);\r\n        if (!target) {\r\n            return this.debugNodeNotFound(d, d.id);\r\n        }\r\n        const sn = this.mirror.getMeta(target);\r\n        if (target === this.iframe.contentDocument) {\r\n            (_a = this.iframe.contentWindow) === null || _a === void 0 ? void 0 : _a.scrollTo({\r\n                top: d.y,\r\n                left: d.x,\r\n                behavior: isSync ? 'auto' : 'smooth',\r\n            });\r\n        }\r\n        else if ((sn === null || sn === void 0 ? void 0 : sn.type) === NodeType.Document) {\r\n            (_b = target.defaultView) === null || _b === void 0 ? void 0 : _b.scrollTo({\r\n                top: d.y,\r\n                left: d.x,\r\n                behavior: isSync ? 'auto' : 'smooth',\r\n            });\r\n        }\r\n        else {\r\n            try {\r\n                target.scrollTo({\r\n                    top: d.y,\r\n                    left: d.x,\r\n                    behavior: isSync ? 'auto' : 'smooth',\r\n                });\r\n            }\r\n            catch (error) {\r\n            }\r\n        }\r\n    }\r\n    applyInput(d) {\r\n        const target = this.mirror.getNode(d.id);\r\n        if (!target) {\r\n            return this.debugNodeNotFound(d, d.id);\r\n        }\r\n        try {\r\n            target.checked = d.isChecked;\r\n            target.value = d.text;\r\n        }\r\n        catch (error) {\r\n        }\r\n    }\r\n    applySelection(d) {\r\n        try {\r\n            const selectionSet = new Set();\r\n            const ranges = d.ranges.map(({ start, startOffset, end, endOffset }) => {\r\n                const startContainer = this.mirror.getNode(start);\r\n                const endContainer = this.mirror.getNode(end);\r\n                if (!startContainer || !endContainer)\r\n                    return;\r\n                const result = new Range();\r\n                result.setStart(startContainer, startOffset);\r\n                result.setEnd(endContainer, endOffset);\r\n                const doc = startContainer.ownerDocument;\r\n                const selection = doc === null || doc === void 0 ? void 0 : doc.getSelection();\r\n                selection && selectionSet.add(selection);\r\n                return {\r\n                    range: result,\r\n                    selection,\r\n                };\r\n            });\r\n            selectionSet.forEach((s) => s.removeAllRanges());\r\n            ranges.forEach((r) => { var _a; return r && ((_a = r.selection) === null || _a === void 0 ? void 0 : _a.addRange(r.range)); });\r\n        }\r\n        catch (error) {\r\n        }\r\n    }\r\n    applyStyleSheetMutation(data) {\r\n        var _a;\r\n        let styleSheet = null;\r\n        if (data.styleId)\r\n            styleSheet = this.styleMirror.getStyle(data.styleId);\r\n        else if (data.id)\r\n            styleSheet =\r\n                ((_a = this.mirror.getNode(data.id)) === null || _a === void 0 ? void 0 : _a.sheet) || null;\r\n        if (!styleSheet)\r\n            return;\r\n        if (data.source === IncrementalSource.StyleSheetRule)\r\n            this.applyStyleSheetRule(data, styleSheet);\r\n        else if (data.source === IncrementalSource.StyleDeclaration)\r\n            this.applyStyleDeclaration(data, styleSheet);\r\n    }\r\n    applyStyleSheetRule(data, styleSheet) {\r\n        var _a, _b, _c, _d;\r\n        (_a = data.adds) === null || _a === void 0 ? void 0 : _a.forEach(({ rule, index: nestedIndex }) => {\r\n            try {\r\n                if (Array.isArray(nestedIndex)) {\r\n                    const { positions, index } = getPositionsAndIndex(nestedIndex);\r\n                    const nestedRule = getNestedRule(styleSheet.cssRules, positions);\r\n                    nestedRule.insertRule(rule, index);\r\n                }\r\n                else {\r\n                    const index = nestedIndex === undefined\r\n                        ? undefined\r\n                        : Math.min(nestedIndex, styleSheet.cssRules.length);\r\n                    styleSheet === null || styleSheet === void 0 ? void 0 : styleSheet.insertRule(rule, index);\r\n                }\r\n            }\r\n            catch (e) {\r\n            }\r\n        });\r\n        (_b = data.removes) === null || _b === void 0 ? void 0 : _b.forEach(({ index: nestedIndex }) => {\r\n            try {\r\n                if (Array.isArray(nestedIndex)) {\r\n                    const { positions, index } = getPositionsAndIndex(nestedIndex);\r\n                    const nestedRule = getNestedRule(styleSheet.cssRules, positions);\r\n                    nestedRule.deleteRule(index || 0);\r\n                }\r\n                else {\r\n                    styleSheet === null || styleSheet === void 0 ? void 0 : styleSheet.deleteRule(nestedIndex);\r\n                }\r\n            }\r\n            catch (e) {\r\n            }\r\n        });\r\n        if (data.replace)\r\n            try {\r\n                void ((_c = styleSheet.replace) === null || _c === void 0 ? void 0 : _c.call(styleSheet, data.replace));\r\n            }\r\n            catch (e) {\r\n            }\r\n        if (data.replaceSync)\r\n            try {\r\n                (_d = styleSheet.replaceSync) === null || _d === void 0 ? void 0 : _d.call(styleSheet, data.replaceSync);\r\n            }\r\n            catch (e) {\r\n            }\r\n    }\r\n    applyStyleDeclaration(data, styleSheet) {\r\n        if (data.set) {\r\n            const rule = getNestedRule(styleSheet.rules, data.index);\r\n            rule.style.setProperty(data.set.property, data.set.value, data.set.priority);\r\n        }\r\n        if (data.remove) {\r\n            const rule = getNestedRule(styleSheet.rules, data.index);\r\n            rule.style.removeProperty(data.remove.property);\r\n        }\r\n    }\r\n    applyAdoptedStyleSheet(data) {\r\n        var _a;\r\n        const targetHost = this.mirror.getNode(data.id);\r\n        if (!targetHost)\r\n            return;\r\n        (_a = data.styles) === null || _a === void 0 ? void 0 : _a.forEach((style) => {\r\n            var _a;\r\n            let newStyleSheet = null;\r\n            let hostWindow = null;\r\n            if (hasShadowRoot(targetHost))\r\n                hostWindow = ((_a = targetHost.ownerDocument) === null || _a === void 0 ? void 0 : _a.defaultView) || null;\r\n            else if (targetHost.nodeName === '#document')\r\n                hostWindow = targetHost.defaultView;\r\n            if (!hostWindow)\r\n                return;\r\n            try {\r\n                newStyleSheet = new hostWindow.CSSStyleSheet();\r\n                this.styleMirror.add(newStyleSheet, style.styleId);\r\n                this.applyStyleSheetRule({\r\n                    source: IncrementalSource.StyleSheetRule,\r\n                    adds: style.rules,\r\n                }, newStyleSheet);\r\n            }\r\n            catch (e) {\r\n            }\r\n        });\r\n        const MAX_RETRY_TIME = 10;\r\n        let count = 0;\r\n        const adoptStyleSheets = (targetHost, styleIds) => {\r\n            const stylesToAdopt = styleIds\r\n                .map((styleId) => this.styleMirror.getStyle(styleId))\r\n                .filter((style) => style !== null);\r\n            if (hasShadowRoot(targetHost))\r\n                targetHost.shadowRoot.adoptedStyleSheets = stylesToAdopt;\r\n            else if (targetHost.nodeName === '#document')\r\n                targetHost.adoptedStyleSheets = stylesToAdopt;\r\n            if (stylesToAdopt.length !== styleIds.length && count < MAX_RETRY_TIME) {\r\n                setTimeout(() => adoptStyleSheets(targetHost, styleIds), 0 + 100 * count);\r\n                count++;\r\n            }\r\n        };\r\n        adoptStyleSheets(targetHost, data.styleIds);\r\n    }\r\n    legacy_resolveMissingNode(map, parent, target, targetMutation) {\r\n        const { previousId, nextId } = targetMutation;\r\n        const previousInMap = previousId && map[previousId];\r\n        const nextInMap = nextId && map[nextId];\r\n        if (previousInMap) {\r\n            const { node, mutation } = previousInMap;\r\n            parent.insertBefore(node, target);\r\n            delete map[mutation.node.id];\r\n            delete this.legacy_missingNodeRetryMap[mutation.node.id];\r\n            if (mutation.previousId || mutation.nextId) {\r\n                this.legacy_resolveMissingNode(map, parent, node, mutation);\r\n            }\r\n        }\r\n        if (nextInMap) {\r\n            const { node, mutation } = nextInMap;\r\n            parent.insertBefore(node, target.nextSibling);\r\n            delete map[mutation.node.id];\r\n            delete this.legacy_missingNodeRetryMap[mutation.node.id];\r\n            if (mutation.previousId || mutation.nextId) {\r\n                this.legacy_resolveMissingNode(map, parent, node, mutation);\r\n            }\r\n        }\r\n    }\r\n    moveAndHover(x, y, id, isSync, debugData) {\r\n        const target = this.mirror.getNode(id);\r\n        if (!target) {\r\n            return this.debugNodeNotFound(debugData, id);\r\n        }\r\n        const base = getBaseDimension(target, this.iframe);\r\n        const _x = x * base.absoluteScale + base.x;\r\n        const _y = y * base.absoluteScale + base.y;\r\n        this.mouse.style.left = `${_x}px`;\r\n        this.mouse.style.top = `${_y}px`;\r\n        if (!isSync) {\r\n            this.drawMouseTail({ x: _x, y: _y });\r\n        }\r\n        this.hoverElements(target);\r\n    }\r\n    drawMouseTail(position) {\r\n        if (!this.mouseTail) {\r\n            return;\r\n        }\r\n        const { lineCap, lineWidth, strokeStyle, duration } = this.config.mouseTail === true\r\n            ? defaultMouseTailConfig\r\n            : Object.assign({}, defaultMouseTailConfig, this.config.mouseTail);\r\n        const draw = () => {\r\n            if (!this.mouseTail) {\r\n                return;\r\n            }\r\n            const ctx = this.mouseTail.getContext('2d');\r\n            if (!ctx || !this.tailPositions.length) {\r\n                return;\r\n            }\r\n            ctx.clearRect(0, 0, this.mouseTail.width, this.mouseTail.height);\r\n            ctx.beginPath();\r\n            ctx.lineWidth = lineWidth;\r\n            ctx.lineCap = lineCap;\r\n            ctx.strokeStyle = strokeStyle;\r\n            ctx.moveTo(this.tailPositions[0].x, this.tailPositions[0].y);\r\n            this.tailPositions.forEach((p) => ctx.lineTo(p.x, p.y));\r\n            ctx.stroke();\r\n        };\r\n        this.tailPositions.push(position);\r\n        draw();\r\n        setTimeout(() => {\r\n            this.tailPositions = this.tailPositions.filter((p) => p !== position);\r\n            draw();\r\n        }, duration / this.speedService.state.context.timer.speed);\r\n    }\r\n    hoverElements(el) {\r\n        var _a;\r\n        (_a = this.iframe.contentDocument) === null || _a === void 0 ? void 0 : _a.querySelectorAll('.\\\\:hover').forEach((hoveredEl) => {\r\n            hoveredEl.classList.remove(':hover');\r\n        });\r\n        let currentEl = el;\r\n        while (currentEl) {\r\n            if (currentEl.classList) {\r\n                currentEl.classList.add(':hover');\r\n            }\r\n            currentEl = currentEl.parentElement;\r\n        }\r\n    }\r\n    isUserInteraction(event) {\r\n        if (event.type !== EventType.IncrementalSnapshot) {\r\n            return false;\r\n        }\r\n        return (event.data.source > IncrementalSource.Mutation &&\r\n            event.data.source <= IncrementalSource.Input);\r\n    }\r\n    backToNormal() {\r\n        this.nextUserInteractionEvent = null;\r\n        if (this.speedService.state.matches('normal')) {\r\n            return;\r\n        }\r\n        this.speedService.send({ type: 'BACK_TO_NORMAL' });\r\n        this.emitter.emit(ReplayerEvents.SkipEnd, {\r\n            speed: this.speedService.state.context.normalSpeed,\r\n        });\r\n    }\r\n    warnNodeNotFound(d, id) {\r\n        this.warn(`Node with id '${id}' not found. `, d);\r\n    }\r\n    warnCanvasMutationFailed(d, error) {\r\n        this.warn(`Has error on canvas update`, error, 'canvas mutation:', d);\r\n    }\r\n    debugNodeNotFound(d, id) {\r\n        this.debug(REPLAY_CONSOLE_PREFIX, `Node with id '${id}' not found. `, d);\r\n    }\r\n    warn(...args) {\r\n        if (!this.config.showWarning) {\r\n            return;\r\n        }\r\n        console.warn(REPLAY_CONSOLE_PREFIX, ...args);\r\n    }\r\n    debug(...args) {\r\n        if (!this.config.showDebug) {\r\n            return;\r\n        }\r\n        console.log(REPLAY_CONSOLE_PREFIX, ...args);\r\n    }\r\n}\n\nexport { Replayer };\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}